<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验数据记录系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .header h1 i {
            margin-right: 10px;
        }
        
        .add-btn {
            background-color: #fff;
            color: #1890ff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .add-btn:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(24, 144, 255, 0.2);
        }
        
        .add-btn i {
            margin-right: 8px;
        }
        
        .content-area {
            padding: 25px;
        }
        
        .content-area h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-results {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
            margin-top: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background-color: #fafafa;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
            white-space: nowrap;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            vertical-align: top;
        }
        
        tr:hover {
            background-color: #fafafa;
        }
        
        .experiment-title {
            font-weight: 600;
            color: #1890ff;
            cursor: pointer;
        }
        
        .object-link {
            color: #1890ff;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }
        
        .period-cell {
            line-height: 1.4;
            white-space: nowrap;
        }
        
        .data-compare-cell {
            line-height: 1.6;
        }
        
        .compare-value {
            display: block;
            margin-bottom: 4px;
        }
        
        .positive {
            color: #f5222d; /* 红色表示增长 */
            font-weight: 600;
        }
        
        .negative {
            color: #52c41a; /* 绿色表示下降 */
            font-weight: 500;
        }
        
        .change-rate {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #fafafa;
            display: inline-block;
            margin-top: 4px;
        }
        
        .positive .change-rate {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
        }
        
        .negative .change-rate {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .delete-btn:hover {
            background-color: #fff1f0;
            border-color: #f5222d;
            color: #f5222d;
        }
        
        /* 合计行样式 */
        .summary-row {
            background-color: #fafafa;
            font-weight: 600;
            color: #333;
        }
        
        .summary-row td {
            border-top: 2px solid #e8e8e8;
            border-bottom: none;
            padding: 16px 12px;
        }
        
        .summary-label {
            color: #666;
            font-weight: 600;
        }
        
        .summary-value {
            color: #1890ff;
        }
        
        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }
        
        .detail-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .detail-value {
            color: #333;
            font-size: 15px;
        }
        
        .object-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .object-detail-table th {
            background-color: #fafafa;
            padding: 10px;
            font-weight: 600;
            color: #666;
            border: 1px solid #e8e8e8;
        }
        
        .object-detail-table td {
            padding: 10px;
            border: 1px solid #f0f0f0;
            text-align: center;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 8px;
        }
        
        .selection-panel {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .selection-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .selection-item:hover {
            background-color: #f5f5f5;
        }
        
        .selection-item input {
            margin-right: 10px;
        }
        
        .selected-count {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .select-all-btn {
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        .clear-btn {
            background: none;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        .compare-object-selection {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 15px;
            background-color: #fafafa;
            margin-top: 10px;
        }
        
        .compare-object-group {
            margin-top: 15px;
        }
        
        .compare-object-group h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .compare-object-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .compare-object-option {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .compare-object-option:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .compare-object-option.selected {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
            font-weight: 500;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .save-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 24px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: white;
            color: #666;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 10px 24px;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #d9d9d9;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .compare-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .compare-type-btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .compare-type-btn.active {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
            font-weight: 500;
        }
        
        .compare-data-section {
            display: none;
        }
        
        .compare-data-section.active {
            display: block;
        }
        
        .explanation {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .explanation i {
            color: #52c41a;
            margin-right: 8px;
        }
        
        .info-message {
            background-color: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .info-message i {
            color: #1890ff;
            margin-right: 8px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading.active {
            display: block;
        }
        
        .loading i {
            margin-right: 8px;
            color: #1890ff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .input-row {
            margin-bottom: 10px;
        }
        
        .input-row label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }
        
        .input-row input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .search-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1><i class="fas fa-clipboard-list"></i> 实验数据记录</h1>
            <button class="add-btn" id="addExperimentBtn">
                <i class="fas fa-plus"></i> 添加实验记录
            </button>
        </div>
        
        <!-- 内容区域 -->
        <div class="content-area">
            <h2>
                <span><i class="fas fa-table"></i> 实验记录表</span>
                <span id="experimentCount" style="font-size: 14px; color: #666; font-weight: normal;"></span>
            </h2>
            
            <!-- 搜索框 -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="搜索实验标题...">
                </div>
                <button class="cancel-btn" id="clearSearchBtn">清除搜索</button>
            </div>
            <div class="search-results" id="searchResults"></div>
            
            <div class="table-container">
                <table id="experimentTable">
                    <thead>
                        <tr>
                            <th>实验标题</th>
                            <th>实验对象</th>
                            <th>销额对比</th>
                            <th>毛利额对比</th>
                            <th>门店贡献对比</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="experimentTableBody">
                        <!-- 合计行放在这里 -->
                        <!-- 数据通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑实验记录表单弹窗 -->
    <div class="modal" id="experimentFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="formModalTitle">添加实验记录</h3>
                <button class="close-btn" id="closeFormModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="experimentForm">
                    <div class="form-group">
                        <label>1. 选择维度类型</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="dimensionStore" name="dimension" value="store" checked>
                                <label for="dimensionStore">门店</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="dimensionProduct" name="dimension" value="product">
                                <label for="dimensionProduct">产品</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 门店选择 -->
                    <div id="storeSelectionSection" class="form-group" style="display: block;">
                        <label>2. 选择门店</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="storeSearch" placeholder="搜索门店...">
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <button type="button" class="select-all-btn" id="selectAllStores">一键全部门店</button>
                            <button type="button" class="clear-btn" id="clearStoreSelection">清除选择</button>
                        </div>
                        
                        <div class="selection-panel" id="storeSelectionPanel">
                            <!-- 选项通过JavaScript动态生成 -->
                        </div>
                        
                        <div class="selected-count">
                            已选择门店: <span id="selectedStoreCount">0</span>个
                        </div>
                    </div>
                    
                    <!-- 产品选择 -->
                    <div id="productSelectionSection" class="form-group" style="display: none;">
                        <label>2. 选择产品</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="productSearch" placeholder="搜索产品...">
                        </div>
                        
                        <div class="selection-panel" id="productSelectionPanel">
                            <!-- 选项通过JavaScript动态生成 -->
                        </div>
                        
                        <div class="selected-count">
                            已选择产品: <span id="selectedProductCount">0</span>个
                            <button type="button" class="clear-btn" id="clearProductSelection">清除选择</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>3. 实验标题</label>
                        <input type="text" id="experimentTitle" placeholder="输入实验标题..." required>
                    </div>
                    
                    <div class="form-group">
                        <label>4. 对比类型</label>
                        <div class="compare-type-selector">
                            <button type="button" class="compare-type-btn active" data-compare-type="time">时间对比</button>
                            <button type="button" class="compare-type-btn" data-compare-type="dimension">维度对比</button>
                        </div>
                    </div>
                    
                    <!-- 时间对比部分 -->
                    <div id="timeCompareSection" class="compare-data-section active">
                        <div class="explanation">
                            <i class="fas fa-info-circle"></i>
                            <strong>时间对比说明：</strong>对比实验对象实验前后的业绩数据，计算绝对值变化。
                        </div>
                        
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>实验周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="experimentStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="experimentEndDate" required>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <label>对比周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="compareStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="compareEndDate" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 维度对比部分 -->
                    <div id="dimensionCompareSection" class="compare-data-section">
                        <div class="explanation">
                            <i class="fas fa-info-circle"></i>
                            <strong>维度对比说明：</strong>对比实验对象和对照对象的环比变化率。展示结果为：实验对象增长率/对照对象增长率 + 相对增长百分点。
                        </div>
                        
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>实验周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="dimensionExperimentStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="dimensionExperimentEndDate" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>选择对比对象</label>
                            <div class="compare-object-selection">
                                <div id="storeCompareSection" style="display: block;">
                                    <h4>选择对比门店</h4>
                                    <div class="search-box">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="compareStoreSearch" placeholder="搜索对比门店...">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <button type="button" class="select-all-btn" id="selectAllCompareStores">全选</button>
                                        <button type="button" class="clear-btn" id="clearCompareStoreSelection">清除</button>
                                    </div>
                                    
                                    <div class="selection-panel" id="compareStorePanel">
                                        <!-- 选项通过JavaScript动态生成 -->
                                    </div>
                                    
                                    <div class="selected-count">
                                        已选择对比门店: <span id="selectedCompareStoreCount">0</span>个
                                    </div>
                                </div>
                                
                                <div id="productCompareSection" style="display: none;">
                                    <h4>选择对比产品类别</h4>
                                    <div class="compare-object-options" id="compareProductOptions">
                                        <!-- 选项通过JavaScript动态生成 -->
                                    </div>
                                    <div class="selected-count">
                                        已选择对比产品类别: <span id="selectedCompareProductCount">0</span>个
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loading" id="formLoading">
                        <i class="fas fa-spinner"></i> 正在计算实验数据，请稍候...
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" id="cancelForm">取消</button>
                        <button type="submit" class="save-btn">保存实验</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 详情弹窗 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">详情</h3>
                <button class="close-btn" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- 详情内容通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 模拟历史销售数据（实际应用中应从数据库获取）
        const historicalSalesData = {
            // 门店历史销售数据（按日期和门店ID）
            stores: {
                1: { // 北京朝阳店
                    "2026-01-07": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2026-01-08": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-09": { sales: 36000, profit: 10800, margin: 30.0 },
                    "2026-01-10": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-11": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2026-01-12": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2026-01-13": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2026-01-14": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2025-12-31": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2026-01-01": { sales: 30000, profit: 9000, margin: 30.0 },
                    "2026-01-02": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2026-01-03": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-04": { sales: 31000, profit: 9300, margin: 30.0 },
                    "2026-01-05": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-06": { sales: 41000, profit: 12300, margin: 30.0 }
                },
                2: { // 上海徐汇店
                    "2026-01-07": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2026-01-08": { sales: 44000, profit: 13200, margin: 30.0 },
                    "2026-01-09": { sales: 46000, profit: 13800, margin: 30.0 },
                    "2026-01-10": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2026-01-11": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2026-01-12": { sales: 52000, profit: 15600, margin: 30.0 },
                    "2026-01-13": { sales: 55000, profit: 16500, margin: 30.0 },
                    "2026-01-14": { sales: 58000, profit: 17400, margin: 30.0 },
                    "2025-12-31": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-01": { sales: 40000, profit: 12000, margin: 30.0 },
                    "2026-01-02": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2026-01-03": { sales: 44000, profit: 13200, margin: 30.0 },
                    "2026-01-04": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2026-01-05": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2026-01-06": { sales: 51000, profit: 15300, margin: 30.0 }
                },
                3: { // 广州天河店
                    "2026-01-07": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2026-01-08": { sales: 30000, profit: 9000, margin: 30.0 },
                    "2026-01-09": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2026-01-10": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-11": { sales: 31000, profit: 9300, margin: 30.0 },
                    "2026-01-12": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-13": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2026-01-14": { sales: 44000, profit: 13200, margin: 30.0 },
                    "2025-12-31": { sales: 24000, profit: 7200, margin: 30.0 },
                    "2026-01-01": { sales: 26000, profit: 7800, margin: 30.0 },
                    "2026-01-02": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2026-01-03": { sales: 30000, profit: 9000, margin: 30.0 },
                    "2026-01-04": { sales: 27000, profit: 8100, margin: 30.0 },
                    "2026-01-05": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-06": { sales: 37000, profit: 11100, margin: 30.0 }
                },
                4: { // 深圳南山店
                    "2026-01-07": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2026-01-08": { sales: 37000, profit: 11100, margin: 30.0 },
                    "2026-01-09": { sales: 39000, profit: 11700, margin: 30.0 },
                    "2026-01-10": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2026-01-11": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-12": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2026-01-13": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2026-01-14": { sales: 51000, profit: 15300, margin: 30.0 },
                    "2025-12-31": { sales: 30000, profit: 9000, margin: 30.0 },
                    "2026-01-01": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2026-01-02": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-03": { sales: 36000, profit: 10800, margin: 30.0 },
                    "2026-01-04": { sales: 33000, profit: 9900, margin: 30.0 },
                    "2026-01-05": { sales: 40000, profit: 12000, margin: 30.0 },
                    "2026-01-06": { sales: 43000, profit: 12900, margin: 30.0 }
                },
                5: { // 成都锦江店
                    "2026-01-07": { sales: 25000, profit: 7500, margin: 30.0 },
                    "2026-01-08": { sales: 27000, profit: 8100, margin: 30.0 },
                    "2026-01-09": { sales: 29000, profit: 8700, margin: 30.0 },
                    "2026-01-10": { sales: 31000, profit: 9300, margin: 30.0 },
                    "2026-01-11": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2026-01-12": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2026-01-13": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2026-01-14": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2025-12-31": { sales: 21000, profit: 6300, margin: 30.0 },
                    "2026-01-01": { sales: 23000, profit: 6900, margin: 30.0 },
                    "2026-01-02": { sales: 25000, profit: 7500, margin: 30.0 },
                    "2026-01-03": { sales: 27000, profit: 8100, margin: 30.0 },
                    "2026-01-04": { sales: 24000, profit: 7200, margin: 30.0 },
                    "2026-01-05": { sales: 31000, profit: 9300, margin: 30.0 },
                    "2026-01-06": { sales: 34000, profit: 10200, margin: 30.0 }
                }
            },
            // 产品历史销售数据（按日期和产品ID）
            products: {
                101: { // 手撕包
                    "2026-01-07": { sales: 8000, profit: 2400, margin: 30.0 },
                    "2026-01-08": { sales: 8500, profit: 2550, margin: 30.0 },
                    "2026-01-09": { sales: 9000, profit: 2700, margin: 30.0 },
                    "2026-01-10": { sales: 9500, profit: 2850, margin: 30.0 },
                    "2026-01-11": { sales: 8800, profit: 2640, margin: 30.0 },
                    "2026-01-12": { sales: 11000, profit: 3300, margin: 30.0 },
                    "2026-01-13": { sales: 12000, profit: 3600, margin: 30.0 },
                    "2026-01-14": { sales: 12500, profit: 3750, margin: 30.0 },
                    "2025-12-31": { sales: 7000, profit: 2100, margin: 30.0 },
                    "2026-01-01": { sales: 7200, profit: 2160, margin: 30.0 },
                    "2026-01-02": { sales: 7400, profit: 2220, margin: 30.0 },
                    "2026-01-03": { sales: 7800, profit: 2340, margin: 30.0 },
                    "2026-01-04": { sales: 7500, profit: 2250, margin: 30.0 },
                    "2026-01-05": { sales: 8200, profit: 2460, margin: 30.0 },
                    "2026-01-06": { sales: 8500, profit: 2550, margin: 30.0 }
                },
                102: { // 现烤品类
                    "2026-01-07": { sales: 25000, profit: 7500, margin: 30.0 },
                    "2026-01-08": { sales: 26000, profit: 7800, margin: 30.0 },
                    "2026-01-09": { sales: 27000, profit: 8100, margin: 30.0 },
                    "2026-01-10": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2026-01-11": { sales: 26500, profit: 7950, margin: 30.0 },
                    "2026-01-12": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2026-01-13": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2026-01-14": { sales: 36000, profit: 10800, margin: 30.0 },
                    "2025-12-31": { sales: 22000, profit: 6600, margin: 30.0 },
                    "2026-01-01": { sales: 22500, profit: 6750, margin: 30.0 },
                    "2026-01-02": { sales: 23000, profit: 6900, margin: 30.0 },
                    "2026-01-03": { sales: 23500, profit: 7050, margin: 30.0 },
                    "2026-01-04": { sales: 22800, profit: 6840, margin: 30.0 },
                    "2026-01-05": { sales: 24500, profit: 7350, margin: 30.0 },
                    "2026-01-06": { sales: 26000, profit: 7800, margin: 30.0 }
                },
                103: { // 饮料品类
                    "2026-01-07": { sales: 18000, profit: 5400, margin: 30.0 },
                    "2026-01-08": { sales: 18500, profit: 5550, margin: 30.0 },
                    "2026-01-09": { sales: 19000, profit: 5700, margin: 30.0 },
                    "2026-01-10": { sales: 19500, profit: 5850, margin: 30.0 },
                    "2026-01-11": { sales: 18800, profit: 5640, margin: 30.0 },
                    "2026-01-12": { sales: 21000, profit: 6300, margin: 30.0 },
                    "2026-01-13": { sales: 22000, profit: 6600, margin: 30.0 },
                    "2026-01-14": { sales: 23000, profit: 6900, margin: 30.0 },
                    "2025-12-31": { sales: 16500, profit: 4950, margin: 30.0 },
                    "2026-01-01": { sales: 16800, profit: 5040, margin: 30.0 },
                    "2026-01-02": { sales: 17000, profit: 5100, margin: 30.0 },
                    "2026-01-03": { sales: 17200, profit: 5160, margin: 30.0 },
                    "2026-01-04": { sales: 16900, profit: 5070, margin: 30.0 },
                    "2026-01-05": { sales: 17500, profit: 5250, margin: 30.0 },
                    "2026-01-06": { sales: 18000, profit: 5400, margin: 30.0 }
                },
                104: { // 零食品类
                    "2026-01-07": { sales: 12000, profit: 3600, margin: 30.0 },
                    "2026-01-08": { sales: 12500, profit: 3750, margin: 30.0 },
                    "2026-01-09": { sales: 13000, profit: 3900, margin: 30.0 },
                    "2026-01-10": { sales: 13500, profit: 4050, margin: 30.0 },
                    "2026-01-11": { sales: 12800, profit: 3840, margin: 30.0 },
                    "2026-01-12": { sales: 15000, profit: 4500, margin: 30.0 },
                    "2026-01-13": { sales: 16000, profit: 4800, margin: 30.0 },
                    "2026-01-14": { sales: 16500, profit: 4950, margin: 30.0 },
                    "2025-12-31": { sales: 11000, profit: 3300, margin: 30.0 },
                    "2026-01-01": { sales: 11200, profit: 3360, margin: 30.0 },
                    "2026-01-02": { sales: 11400, profit: 3420, margin: 30.0 },
                    "2026-01-03": { sales: 11600, profit: 3480, margin: 30.0 },
                    "2026-01-04": { sales: 11300, profit: 3390, margin: 30.0 },
                    "2026-01-05": { sales: 11800, profit: 3540, margin: 30.0 },
                    "2026-01-06": { sales: 12000, profit: 3600, margin: 30.0 }
                }
            }
        };

        // 实验数据
        let experimentData = [
            {
                id: 1,
                title: "手撕包促销实验",
                dimension: "product",
                objectType: "产品",
                objectNames: ["手撕包"],
                compareType: "dimension",
                experimentPeriod: "2026-01-07 至 2026-01-14",
                comparePeriod: "2025-12-31 至 2026-01-06",
                compareObject: "现烤品类",
                salesCompare: "15%/10% +5",
                profitCompare: "25%/10% +15",
                storeContribution: "--",
                objectDetails: [
                    { 
                        name: "手撕包", 
                        experimentSales: 75000, 
                        compareSales: 60000,
                        experimentProfit: 22500,
                        compareProfit: 18000,
                        salesGrowthRate: 25.0,
                        profitGrowthRate: 25.0
                    }
                ],
                compareObjectDetails: [
                    {
                        name: "现烤品类",
                        experimentSales: 220000,
                        compareSales: 200000,
                        experimentProfit: 66000,
                        compareProfit: 60000,
                        salesGrowthRate: 10.0,
                        profitGrowthRate: 10.0
                    }
                ]
            },
            {
                id: 2,
                title: "周末门店促销",
                dimension: "store",
                objectType: "门店",
                objectNames: ["北京朝阳店", "上海徐汇店"],
                compareType: "time",
                experimentPeriod: "2026-01-07 至 2026-01-14",
                comparePeriod: "2025-12-31 至 2026-01-06",
                compareObject: "时间对比",
                salesCompare: "¥300,000/¥250,000 +20%",
                profitCompare: "¥90,000/¥75,000 +20%",
                storeContribution: "65%",
                objectDetails: [
                    { 
                        name: "北京朝阳店", 
                        experimentSales: 160000, 
                        compareSales: 140000,
                        experimentProfit: 48000,
                        compareProfit: 42000,
                        salesGrowthRate: 14.3,
                        profitGrowthRate: 14.3
                    },
                    { 
                        name: "上海徐汇店", 
                        experimentSales: 140000, 
                        compareSales: 110000,
                        experimentProfit: 42000,
                        compareProfit: 33000,
                        salesGrowthRate: 27.3,
                        profitGrowthRate: 27.3
                    }
                ]
            }
        ];

        // 选择对象数据
        const storeOptions = [
            { id: 1, name: "北京朝阳店", group: "华北区" },
            { id: 2, name: "上海徐汇店", group: "华东区" },
            { id: 3, name: "广州天河店", group: "华南区" },
            { id: 4, name: "深圳南山店", group: "华南区" },
            { id: 5, name: "成都锦江店", group: "西南区" },
            { id: 6, name: "武汉江汉店", group: "华中区" },
            { id: 7, name: "南京鼓楼店", group: "华东区" },
            { id: 8, name: "西安雁塔店", group: "西北区" },
            { id: 9, name: "杭州西湖店", group: "华东区" },
            { id: 10, name: "苏州观前店", group: "华东区" }
        ];

        const productOptions = [
            { id: 101, name: "手撕包", group: "现烤品类" },
            { id: 102, name: "现烤品类", group: "现烤品类" },
            { id: 103, name: "饮料品类", group: "饮料" },
            { id: 104, name: "零食品类", group: "零食" },
            { id: 105, name: "面包", group: "现烤品类" },
            { id: 106, name: "蛋糕", group: "现烤品类" },
            { id: 107, name: "饼干", group: "零食" },
            { id: 108, name: "巧克力", group: "零食" }
        ];

        // 产品类别选项
        const productCategoryOptions = [
            { id: "现烤品类", name: "现烤品类" },
            { id: "饮料", name: "饮料" },
            { id: "零食", name: "零食" },
            { id: "日用品", name: "日用品" },
            { id: "冷冻食品", name: "冷冻食品" }
        ];

        // DOM元素
        const experimentTableBody = document.getElementById('experimentTableBody');
        const experimentFormModal = document.getElementById('experimentFormModal');
        const detailModal = document.getElementById('detailModal');
        const addExperimentBtn = document.getElementById('addExperimentBtn');
        const closeFormModal = document.getElementById('closeFormModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const cancelForm = document.getElementById('cancelForm');
        const experimentForm = document.getElementById('experimentForm');
        const formModalTitle = document.getElementById('formModalTitle');
        const detailModalTitle = document.getElementById('detailModalTitle');
        const detailModalBody = document.getElementById('detailModalBody');
        const timeCompareSection = document.getElementById('timeCompareSection');
        const dimensionCompareSection = document.getElementById('dimensionCompareSection');
        const formLoading = document.getElementById('formLoading');
        const compareTypeButtons = document.querySelectorAll('.compare-type-btn');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchResults = document.getElementById('searchResults');
        const experimentCount = document.getElementById('experimentCount');
        
        // 维度选择相关
        const dimensionStore = document.getElementById('dimensionStore');
        const dimensionProduct = document.getElementById('dimensionProduct');
        
        // 门店选择相关
        const storeSelectionSection = document.getElementById('storeSelectionSection');
        const storeSearch = document.getElementById('storeSearch');
        const storeSelectionPanel = document.getElementById('storeSelectionPanel');
        const selectedStoreCount = document.getElementById('selectedStoreCount');
        const clearStoreSelection = document.getElementById('clearStoreSelection');
        const selectAllStores = document.getElementById('selectAllStores');
        
        // 产品选择相关
        const productSelectionSection = document.getElementById('productSelectionSection');
        const productSearch = document.getElementById('productSearch');
        const productSelectionPanel = document.getElementById('productSelectionPanel');
        const selectedProductCount = document.getElementById('selectedProductCount');
        const clearProductSelection = document.getElementById('clearProductSelection');
        
        // 对比对象选择相关
        const storeCompareSection = document.getElementById('storeCompareSection');
        const productCompareSection = document.getElementById('productCompareSection');
        const compareStoreSearch = document.getElementById('compareStoreSearch');
        const compareStorePanel = document.getElementById('compareStorePanel');
        const selectedCompareStoreCount = document.getElementById('selectedCompareStoreCount');
        const clearCompareStoreSelection = document.getElementById('clearCompareStoreSelection');
        const selectAllCompareStores = document.getElementById('selectAllCompareStores');
        const compareProductOptions = document.getElementById('compareProductOptions');
        const selectedCompareProductCount = document.getElementById('selectedCompareProductCount');

        // 当前选择的维度
        let currentDimension = 'store';
        // 当前选择的对象
        let selectedStores = [];
        let selectedProducts = [];
        // 当前选择的对比对象
        let selectedCompareStores = [];
        let selectedCompareProductCategories = [];
        // 当前编辑的实验ID (null表示新增)
        let editingExperimentId = null;
        // 当前对比类型
        let currentCompareType = 'time';
        // 当前搜索关键词
        let currentSearchKeyword = '';

        // 初始化页面
        function initPage() {
            renderExperimentTable();
            setupEventListeners();
            
            // 设置默认日期
            const today = new Date();
            const experimentStartDate = document.getElementById('experimentStartDate');
            const experimentEndDate = document.getElementById('experimentEndDate');
            
            // 设置实验开始日期为今天
            experimentStartDate.valueAsDate = today;
            
            // 设置实验结束日期为7天后
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 7);
            experimentEndDate.valueAsDate = endDate;
            
            // 维度对比的日期
            const dimensionExperimentStartDate = document.getElementById('dimensionExperimentStartDate');
            const dimensionExperimentEndDate = document.getElementById('dimensionExperimentEndDate');
            dimensionExperimentStartDate.valueAsDate = today;
            dimensionExperimentEndDate.valueAsDate = endDate;
            
            // 设置对比周期默认值为实验周期前7天
            const compareStartDate = document.getElementById('compareStartDate');
            const compareEndDate = document.getElementById('compareEndDate');
            
            const compareStart = new Date(today);
            compareStart.setDate(compareStart.getDate() - 7);
            const compareEnd = new Date(today);
            compareEnd.setDate(compareEnd.getDate() - 1);
            
            compareStartDate.valueAsDate = compareStart;
            compareEndDate.valueAsDate = compareEnd;
            
            // 初始化产品类别选择
            renderProductCategoryOptions();
        }

        // 渲染实验表格
        function renderExperimentTable() {
            // 过滤实验数据
            let filteredExperiments = experimentData;
            
            if (currentSearchKeyword) {
                filteredExperiments = experimentData.filter(experiment => 
                    experiment.title.toLowerCase().includes(currentSearchKeyword.toLowerCase())
                );
            }
            
            experimentTableBody.innerHTML = '';
            
            if (filteredExperiments.length === 0) {
                experimentTableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <h3>暂无实验记录</h3>
                                <p>${currentSearchKeyword ? '未找到匹配的实验记录，请尝试其他搜索词' : '点击"添加实验记录"按钮创建第一个实验'}</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // 更新实验计数
                experimentCount.textContent = `(0条记录)`;
                searchResults.innerHTML = currentSearchKeyword ? 
                    `未找到包含"${currentSearchKeyword}"的实验记录` : 
                    '';
                    
                return;
            }
            
            // 计算合计数据
            let totalExperimentSales = 0;
            let totalCompareSales = 0;
            let totalExperimentProfit = 0;
            let totalCompareProfit = 0;
            
            // 先添加合计行
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            
            // 遍历实验数据计算合计
            filteredExperiments.forEach(experiment => {
                // 提取数字部分用于合计
                experiment.objectDetails.forEach(detail => {
                    totalExperimentSales += detail.experimentSales || 0;
                    totalCompareSales += detail.compareSales || 0;
                    totalExperimentProfit += detail.experimentProfit || 0;
                    totalCompareProfit += detail.compareProfit || 0;
                });
            });
            
            // 计算合计的变化率
            const totalSalesGrowthRate = totalCompareSales > 0 ? 
                ((totalExperimentSales - totalCompareSales) / totalCompareSales * 100).toFixed(1) : 0;
            const totalProfitGrowthRate = totalCompareProfit > 0 ? 
                ((totalExperimentProfit - totalCompareProfit) / totalCompareProfit * 100).toFixed(1) : 0;
            
            const totalSalesChangeClass = totalSalesGrowthRate >= 0 ? 'positive' : 'negative';
            const totalProfitChangeClass = totalProfitGrowthRate >= 0 ? 'positive' : 'negative';
            const totalSalesChangeSign = totalSalesGrowthRate >= 0 ? '+' : '';
            const totalProfitChangeSign = totalProfitGrowthRate >= 0 ? '+' : '';
            
            summaryRow.innerHTML = `
                <td class="summary-label">合计</td>
                <td>${filteredExperiments.length}个实验</td>
                <td class="data-compare-cell ${totalSalesChangeClass}">
                    <span class="compare-value">¥${totalExperimentSales.toLocaleString()}/¥${totalCompareSales.toLocaleString()}</span>
                    <span class="change-rate">${totalSalesChangeSign}${totalSalesGrowthRate}%</span>
                </td>
                <td class="data-compare-cell ${totalProfitChangeClass}">
                    <span class="compare-value">¥${totalExperimentProfit.toLocaleString()}/¥${totalCompareProfit.toLocaleString()}</span>
                    <span class="change-rate">${totalProfitChangeSign}${totalProfitGrowthRate}%</span>
                </td>
                <td>--</td>
                <td>--</td>
            `;
            
            experimentTableBody.appendChild(summaryRow);
            
            // 添加数据行
            filteredExperiments.forEach(experiment => {
                // 确定实验对象显示
                let objectDisplay = '';
                if (experiment.dimension === 'store') {
                    objectDisplay = `${experiment.objectType}(${experiment.objectNames.length})`;
                } else {
                    objectDisplay = `${experiment.objectNames.join(', ')}`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="experiment-title">${experiment.title}</div>
                    </td>
                    <td>
                        <span class="object-link" data-id="${experiment.id}" data-type="object">
                            ${objectDisplay}
                        </span>
                    </td>
                    <td class="data-compare-cell">
                        ${experiment.salesCompare}
                    </td>
                    <td class="data-compare-cell">
                        ${experiment.profitCompare}
                    </td>
                    <td>
                        ${experiment.storeContribution}
                    </td>
                    <td>
                        <div class="actions">
                            <button class="action-btn edit-btn" data-id="${experiment.id}">编辑</button>
                            <button class="action-btn delete-btn" data-id="${experiment.id}">删除</button>
                        </div>
                    </td>
                `;
                
                experimentTableBody.appendChild(row);
            });
            
            // 更新实验计数
            const totalCount = experimentData.length;
            const filteredCount = filteredExperiments.length;
            experimentCount.textContent = `(${filteredCount}条记录${currentSearchKeyword && filteredCount !== totalCount ? `，共${totalCount}条` : ''})`;
            
            // 更新搜索结果显示
            if (currentSearchKeyword) {
                searchResults.innerHTML = `找到 ${filteredCount} 条包含"<strong>${currentSearchKeyword}</strong>"的实验记录`;
            } else {
                searchResults.innerHTML = '';
            }
            
            // 添加事件监听器
            document.querySelectorAll('.object-link').forEach(link => {
                link.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    showObjectDetailModal(experimentId);
                });
            });
            
            document.querySelectorAll('.experiment-title').forEach(title => {
                title.addEventListener('click', function() {
                    const experimentId = parseInt(this.closest('tr').querySelector('.edit-btn').getAttribute('data-id'));
                    showExperimentDetailModal(experimentId);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    editExperiment(experimentId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    deleteExperiment(experimentId);
                });
            });
        }

        // 计算变化率
        function calculateChangeRate(before, after) {
            if (before === 0) return 0;
            return Math.round(((after - before) / before) * 100 * 10) / 10;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 添加实验按钮
            addExperimentBtn.addEventListener('click', () => {
                editingExperimentId = null;
                formModalTitle.textContent = '添加实验记录';
                resetForm();
                experimentFormModal.classList.add('active');
            });

            // 关闭表单弹窗
            closeFormModal.addEventListener('click', () => {
                experimentFormModal.classList.remove('active');
            });

            // 关闭详情弹窗
            closeDetailModal.addEventListener('click', () => {
                detailModal.classList.remove('active');
            });

            // 取消表单
            cancelForm.addEventListener('click', () => {
                experimentFormModal.classList.remove('active');
            });

            // 表单提交
            experimentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveExperiment();
            });

            // 维度选择变化
            document.querySelectorAll('input[name="dimension"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentDimension = this.value;
                    updateSelectionSections();
                    
                    // 重置选择
                    selectedStores = [];
                    selectedProducts = [];
                    updateStoreSelectionPanel();
                    updateProductSelectionPanel();
                    updateSelectedCounts();
                    
                    // 更新对比对象选择
                    updateCompareObjectSelection();
                });
            });

            // 门店搜索框
            storeSearch.addEventListener('input', function() {
                updateStoreSelectionPanel();
            });
            
            // 产品搜索框
            productSearch.addEventListener('input', function() {
                updateProductSelectionPanel();
            });
            
            // 对比门店搜索框
            compareStoreSearch.addEventListener('input', function() {
                updateCompareStorePanel();
            });

            // 清除门店选择
            clearStoreSelection.addEventListener('click', function() {
                selectedStores = [];
                updateSelectedCounts();
                updateStoreSelectionPanel();
            });
            
            // 全选门店
            selectAllStores.addEventListener('click', function() {
                selectedStores = [...storeOptions];
                updateSelectedCounts();
                updateStoreSelectionPanel();
            });
            
            // 清除产品选择
            clearProductSelection.addEventListener('click', function() {
                selectedProducts = [];
                updateSelectedCounts();
                updateProductSelectionPanel();
            });
            
            // 清除对比门店选择
            clearCompareStoreSelection.addEventListener('click', function() {
                selectedCompareStores = [];
                updateSelectedCompareCounts();
                updateCompareStorePanel();
            });
            
            // 全选对比门店
            selectAllCompareStores.addEventListener('click', function() {
                selectedCompareStores = [...storeOptions];
                updateSelectedCompareCounts();
                updateCompareStorePanel();
            });
            
            // 对比类型切换
            compareTypeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const compareType = this.getAttribute('data-compare-type');
                    switchCompareType(compareType);
                });
            });
            
            // 搜索框输入事件
            searchInput.addEventListener('input', function() {
                currentSearchKeyword = this.value.trim();
                renderExperimentTable();
            });
            
            // 清除搜索按钮
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                currentSearchKeyword = '';
                renderExperimentTable();
            });
        }
        
        // 切换对比类型
        function switchCompareType(compareType) {
            currentCompareType = compareType;
            
            // 更新按钮状态
            compareTypeButtons.forEach(btn => {
                if (btn.getAttribute('data-compare-type') === compareType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 显示对应的数据输入部分
            if (compareType === 'time') {
                timeCompareSection.classList.add('active');
                dimensionCompareSection.classList.remove('active');
            } else {
                timeCompareSection.classList.remove('active');
                dimensionCompareSection.classList.add('active');
            }
        }
        
        // 更新选择区域显示
        function updateSelectionSections() {
            // 隐藏所有选择区域
            storeSelectionSection.style.display = 'none';
            productSelectionSection.style.display = 'none';
            
            // 根据当前维度显示对应选择区域
            if (currentDimension === 'store') {
                storeSelectionSection.style.display = 'block';
                updateStoreSelectionPanel();
            } else if (currentDimension === 'product') {
                productSelectionSection.style.display = 'block';
                updateProductSelectionPanel();
            }
            
            // 更新对比对象选择
            updateCompareObjectSelection();
        }
        
        // 更新门店选择面板
        function updateStoreSelectionPanel() {
            storeSelectionPanel.innerHTML = '';
            const searchTerm = storeSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            storeOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    storeSelectionPanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedStores.some(store => store.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="store_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="store_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedStores.push(option);
                        } else {
                            selectedStores = selectedStores.filter(store => store.id !== option.id);
                        }
                        updateSelectedCounts();
                    });
                    
                    storeSelectionPanel.appendChild(item);
                });
            });
        }
        
        // 更新产品选择面板
        function updateProductSelectionPanel() {
            productSelectionPanel.innerHTML = '';
            const searchTerm = productSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            productOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    productSelectionPanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedProducts.some(product => product.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="product_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="product_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedProducts.push(option);
                        } else {
                            selectedProducts = selectedProducts.filter(product => product.id !== option.id);
                        }
                        updateSelectedCounts();
                    });
                    
                    productSelectionPanel.appendChild(item);
                });
            });
        }
        
        // 更新对比对象选择
        function updateCompareObjectSelection() {
            if (currentDimension === 'store') {
                storeCompareSection.style.display = 'block';
                productCompareSection.style.display = 'none';
                updateCompareStorePanel();
            } else {
                storeCompareSection.style.display = 'none';
                productCompareSection.style.display = 'block';
                updateProductCategoryOptions();
            }
        }
        
        // 更新对比门店面板
        function updateCompareStorePanel() {
            compareStorePanel.innerHTML = '';
            const searchTerm = compareStoreSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            storeOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    compareStorePanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    // 检查是否是实验对象门店，如果是则禁用
                    const isExperimentStore = selectedStores.some(store => store.id === option.id);
                    const isSelected = selectedCompareStores.some(store => store.id === option.id);
                    
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    if (isExperimentStore) {
                        item.style.opacity = '0.5';
                        item.style.cursor = 'not-allowed';
                    }
                    
                    item.innerHTML = `
                        <input type="checkbox" id="compare_store_${option.id}" ${isSelected ? 'checked' : ''} ${isExperimentStore ? 'disabled' : ''}>
                        <label for="compare_store_${option.id}">${option.name}${isExperimentStore ? ' (实验对象)' : ''}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    if (!isExperimentStore) {
                        checkbox.addEventListener('change', function() {
                            if (this.checked) {
                                selectedCompareStores.push(option);
                            } else {
                                selectedCompareStores = selectedCompareStores.filter(store => store.id !== option.id);
                            }
                            updateSelectedCompareCounts();
                        });
                    }
                    
                    compareStorePanel.appendChild(item);
                });
            });
        }
        
        // 渲染产品类别选项
        function renderProductCategoryOptions() {
            compareProductOptions.innerHTML = '';
            
            productCategoryOptions.forEach(category => {
                const isSelected = selectedCompareProductCategories.includes(category.id);
                const option = document.createElement('div');
                option.className = `compare-object-option ${isSelected ? 'selected' : ''}`;
                option.textContent = category.name;
                option.dataset.categoryId = category.id;
                
                option.addEventListener('click', function() {
                    const categoryId = this.dataset.categoryId;
                    if (selectedCompareProductCategories.includes(categoryId)) {
                        selectedCompareProductCategories = selectedCompareProductCategories.filter(id => id !== categoryId);
                    } else {
                        selectedCompareProductCategories.push(categoryId);
                    }
                    updateSelectedCompareCounts();
                    renderProductCategoryOptions();
                });
                
                compareProductOptions.appendChild(option);
            });
        }
        
        // 更新产品类别选项（检查是否是实验对象品类）
        function updateProductCategoryOptions() {
            compareProductOptions.innerHTML = '';
            
            // 获取实验产品的品类
            const experimentCategories = selectedProducts.map(product => product.group);
            
            productCategoryOptions.forEach(category => {
                const isExperimentCategory = experimentCategories.includes(category.id);
                const isSelected = selectedCompareProductCategories.includes(category.id);
                
                const option = document.createElement('div');
                option.className = `compare-object-option ${isSelected ? 'selected' : ''}`;
                if (isExperimentCategory) {
                    option.style.opacity = '0.5';
                    option.style.cursor = 'not-allowed';
                }
                option.textContent = category.name + (isExperimentCategory ? ' (实验对象)' : '');
                option.dataset.categoryId = category.id;
                
                if (!isExperimentCategory) {
                    option.addEventListener('click', function() {
                        const categoryId = this.dataset.categoryId;
                        if (selectedCompareProductCategories.includes(categoryId)) {
                            selectedCompareProductCategories = selectedCompareProductCategories.filter(id => id !== categoryId);
                        } else {
                            selectedCompareProductCategories.push(categoryId);
                        }
                        updateSelectedCompareCounts();
                        updateProductCategoryOptions();
                    });
                }
                
                compareProductOptions.appendChild(option);
            });
        }
        
        // 更新所有已选择数量
        function updateSelectedCounts() {
            selectedStoreCount.textContent = selectedStores.length;
            selectedProductCount.textContent = selectedProducts.length;
        }
        
        // 更新对比对象已选择数量
        function updateSelectedCompareCounts() {
            selectedCompareStoreCount.textContent = selectedCompareStores.length;
            selectedCompareProductCount.textContent = selectedCompareProductCategories.length;
        }

        // 重置表单
        function resetForm() {
            experimentForm.reset();
            selectedStores = [];
            selectedProducts = [];
            selectedCompareStores = [];
            selectedCompareProductCategories = [];
            updateSelectedCounts();
            updateSelectedCompareCounts();
            
            // 设置默认维度为门店
            document.getElementById('dimensionStore').checked = true;
            currentDimension = 'store';
            currentCompareType = 'time';
            
            // 设置默认对比类型按钮
            compareTypeButtons.forEach(btn => {
                if (btn.getAttribute('data-compare-type') === 'time') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新选择区域
            updateSelectionSections();
            
            // 显示时间对比部分
            timeCompareSection.classList.add('active');
            dimensionCompareSection.classList.remove('active');
            
            // 设置默认日期
            const today = new Date();
            const experimentStartDate = document.getElementById('experimentStartDate');
            const experimentEndDate = document.getElementById('experimentEndDate');
            
            experimentStartDate.valueAsDate = today;
            
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 7);
            experimentEndDate.valueAsDate = endDate;
            
            // 维度对比的日期
            const dimensionExperimentStartDate = document.getElementById('dimensionExperimentStartDate');
            const dimensionExperimentEndDate = document.getElementById('dimensionExperimentEndDate');
            dimensionExperimentStartDate.valueAsDate = today;
            dimensionExperimentEndDate.valueAsDate = endDate;
            
            // 设置对比周期默认值为实验周期前7天
            const compareStartDate = document.getElementById('compareStartDate');
            const compareEndDate = document.getElementById('compareEndDate');
            
            const compareStart = new Date(today);
            compareStart.setDate(compareStart.getDate() - 7);
            const compareEnd = new Date(today);
            compareEnd.setDate(compareEnd.getDate() - 1);
            
            compareStartDate.valueAsDate = compareStart;
            compareEndDate.valueAsDate = compareEnd;
            
            // 更新产品类别选择
            updateProductCategoryOptions();
        }

        // 模拟从数据库获取数据
        function calculateExperimentData(experimentInfo) {
            // 模拟计算延迟
            return new Promise((resolve) => {
                setTimeout(() => {
                    let result = {
                        objectDetails: [],
                        compareObjectDetails: [],
                        salesCompare: '',
                        profitCompare: '',
                        storeContribution: '--'
                    };
                    
                    if (experimentInfo.compareType === 'time') {
                        // 时间对比：计算绝对值变化
                        const experimentPeriod = experimentInfo.experimentPeriod.split(' 至 ');
                        const comparePeriod = experimentInfo.comparePeriod.split(' 至 ');
                        
                        if (experimentInfo.dimension === 'store') {
                            // 门店维度 - 时间对比
                            let totalExperimentSales = 0;
                            let totalCompareSales = 0;
                            let totalExperimentProfit = 0;
                            let totalCompareProfit = 0;
                            
                            selectedStores.forEach(store => {
                                const storeExperimentData = calculatePeriodDataForStore(
                                    store.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                const storeCompareData = calculatePeriodDataForStore(
                                    store.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                totalExperimentSales += storeExperimentData.sales;
                                totalCompareSales += storeCompareData.sales;
                                totalExperimentProfit += storeExperimentData.profit;
                                totalCompareProfit += storeCompareData.profit;
                                
                                // 添加门店详情
                                result.objectDetails.push({
                                    name: store.name,
                                    experimentSales: storeExperimentData.sales,
                                    compareSales: storeCompareData.sales,
                                    experimentProfit: storeExperimentData.profit,
                                    compareProfit: storeCompareData.profit,
                                    salesGrowthRate: calculateChangeRate(storeCompareData.sales, storeExperimentData.sales),
                                    profitGrowthRate: calculateChangeRate(storeCompareData.profit, storeExperimentData.profit)
                                });
                            });
                            
                            // 计算整体变化率
                            const salesGrowthRate = calculateChangeRate(totalCompareSales, totalExperimentSales);
                            const profitGrowthRate = calculateChangeRate(totalCompareProfit, totalExperimentProfit);
                            
                            // 格式化显示
                            result.salesCompare = `¥${totalExperimentSales.toLocaleString()}/¥${totalCompareSales.toLocaleString()} ${salesGrowthRate >= 0 ? '+' : ''}${salesGrowthRate}%`;
                            result.profitCompare = `¥${totalExperimentProfit.toLocaleString()}/¥${totalCompareProfit.toLocaleString()} ${profitGrowthRate >= 0 ? '+' : ''}${profitGrowthRate}%`;
                            
                            // 计算门店贡献
                            if (selectedStores.length > 0) {
                                result.storeContribution = '待计算';
                            }
                            
                        } else if (experimentInfo.dimension === 'product') {
                            // 产品维度 - 时间对比
                            let totalExperimentSales = 0;
                            let totalCompareSales = 0;
                            let totalExperimentProfit = 0;
                            let totalCompareProfit = 0;
                            
                            selectedProducts.forEach(product => {
                                const productExperimentData = calculatePeriodDataForProduct(
                                    product.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                const productCompareData = calculatePeriodDataForProduct(
                                    product.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                totalExperimentSales += productExperimentData.sales;
                                totalCompareSales += productCompareData.sales;
                                totalExperimentProfit += productExperimentData.profit;
                                totalCompareProfit += productCompareData.profit;
                                
                                // 添加产品详情
                                result.objectDetails.push({
                                    name: product.name,
                                    experimentSales: productExperimentData.sales,
                                    compareSales: productCompareData.sales,
                                    experimentProfit: productExperimentData.profit,
                                    compareProfit: productCompareData.profit,
                                    salesGrowthRate: calculateChangeRate(productCompareData.sales, productExperimentData.sales),
                                    profitGrowthRate: calculateChangeRate(productCompareData.profit, productExperimentData.profit)
                                });
                            });
                            
                            // 计算整体变化率
                            const salesGrowthRate = calculateChangeRate(totalCompareSales, totalExperimentSales);
                            const profitGrowthRate = calculateChangeRate(totalCompareProfit, totalExperimentProfit);
                            
                            // 格式化显示
                            result.salesCompare = `¥${totalExperimentSales.toLocaleString()}/¥${totalCompareSales.toLocaleString()} ${salesGrowthRate >= 0 ? '+' : ''}${salesGrowthRate}%`;
                            result.profitCompare = `¥${totalExperimentProfit.toLocaleString()}/¥${totalCompareProfit.toLocaleString()} ${profitGrowthRate >= 0 ? '+' : ''}${profitGrowthRate}%`;
                            
                        }
                        
                    } else {
                        // 维度对比：计算环比变化率对比
                        const experimentPeriod = experimentInfo.experimentPeriod.split(' 至 ');
                        const comparePeriod = experimentInfo.comparePeriod.split(' 至 ');
                        
                        if (experimentInfo.dimension === 'store') {
                            // 门店维度 - 维度对比
                            // 计算实验对象数据
                            let experimentGroupExperimentSales = 0;
                            let experimentGroupCompareSales = 0;
                            let experimentGroupExperimentProfit = 0;
                            let experimentGroupCompareProfit = 0;
                            
                            selectedStores.forEach(store => {
                                const storeExperimentData = calculatePeriodDataForStore(
                                    store.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                const storeCompareData = calculatePeriodDataForStore(
                                    store.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                experimentGroupExperimentSales += storeExperimentData.sales;
                                experimentGroupCompareSales += storeCompareData.sales;
                                experimentGroupExperimentProfit += storeExperimentData.profit;
                                experimentGroupCompareProfit += storeCompareData.profit;
                                
                                // 添加实验门店详情
                                result.objectDetails.push({
                                    name: store.name,
                                    experimentSales: storeExperimentData.sales,
                                    compareSales: storeCompareData.sales,
                                    experimentProfit: storeExperimentData.profit,
                                    compareProfit: storeCompareData.profit,
                                    salesGrowthRate: calculateChangeRate(storeCompareData.sales, storeExperimentData.sales),
                                    profitGrowthRate: calculateChangeRate(storeCompareData.profit, storeExperimentData.profit)
                                });
                            });
                            
                            // 计算对比对象数据
                            let compareGroupExperimentSales = 0;
                            let compareGroupCompareSales = 0;
                            let compareGroupExperimentProfit = 0;
                            let compareGroupCompareProfit = 0;
                            
                            selectedCompareStores.forEach(store => {
                                const storeExperimentData = calculatePeriodDataForStore(
                                    store.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                const storeCompareData = calculatePeriodDataForStore(
                                    store.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                compareGroupExperimentSales += storeExperimentData.sales;
                                compareGroupCompareSales += storeCompareData.sales;
                                compareGroupExperimentProfit += storeExperimentData.profit;
                                compareGroupCompareProfit += storeCompareData.profit;
                                
                                // 添加对比门店详情
                                result.compareObjectDetails.push({
                                    name: store.name,
                                    experimentSales: storeExperimentData.sales,
                                    compareSales: storeCompareData.sales,
                                    experimentProfit: storeExperimentData.profit,
                                    compareProfit: storeCompareData.profit,
                                    salesGrowthRate: calculateChangeRate(storeCompareData.sales, storeExperimentData.sales),
                                    profitGrowthRate: calculateChangeRate(storeCompareData.profit, storeExperimentData.profit)
                                });
                            });
                            
                            // 计算增长率
                            const experimentGroupSalesGrowthRate = calculateChangeRate(experimentGroupCompareSales, experimentGroupExperimentSales);
                            const compareGroupSalesGrowthRate = calculateChangeRate(compareGroupCompareSales, compareGroupExperimentSales);
                            const experimentGroupProfitGrowthRate = calculateChangeRate(experimentGroupCompareProfit, experimentGroupExperimentProfit);
                            const compareGroupProfitGrowthRate = calculateChangeRate(compareGroupCompareProfit, compareGroupExperimentProfit);
                            
                            // 计算相对增长百分点
                            const relativeSalesGrowth = (experimentGroupSalesGrowthRate - compareGroupSalesGrowthRate).toFixed(1);
                            const relativeProfitGrowth = (experimentGroupProfitGrowthRate - compareGroupProfitGrowthRate).toFixed(1);
                            
                            // 格式化显示
                            result.salesCompare = `${experimentGroupSalesGrowthRate}%/${compareGroupSalesGrowthRate}% ${parseFloat(relativeSalesGrowth) >= 0 ? '+' : ''}${relativeSalesGrowth}`;
                            result.profitCompare = `${experimentGroupProfitGrowthRate}%/${compareGroupProfitGrowthRate}% ${parseFloat(relativeProfitGrowth) >= 0 ? '+' : ''}${relativeProfitGrowth}`;
                            
                            // 确定对比对象名称
                            if (selectedCompareStores.length > 0) {
                                experimentInfo.compareObject = selectedCompareStores.map(store => store.name).join(', ');
                            }
                            
                        } else if (experimentInfo.dimension === 'product') {
                            // 产品维度 - 维度对比
                            // 计算实验对象数据
                            let experimentGroupExperimentSales = 0;
                            let experimentGroupCompareSales = 0;
                            let experimentGroupExperimentProfit = 0;
                            let experimentGroupCompareProfit = 0;
                            
                            selectedProducts.forEach(product => {
                                const productExperimentData = calculatePeriodDataForProduct(
                                    product.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                const productCompareData = calculatePeriodDataForProduct(
                                    product.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                experimentGroupExperimentSales += productExperimentData.sales;
                                experimentGroupCompareSales += productCompareData.sales;
                                experimentGroupExperimentProfit += productExperimentData.profit;
                                experimentGroupCompareProfit += productCompareData.profit;
                                
                                // 添加实验产品详情
                                result.objectDetails.push({
                                    name: product.name,
                                    experimentSales: productExperimentData.sales,
                                    compareSales: productCompareData.sales,
                                    experimentProfit: productExperimentData.profit,
                                    compareProfit: productCompareData.profit,
                                    salesGrowthRate: calculateChangeRate(productCompareData.sales, productExperimentData.sales),
                                    profitGrowthRate: calculateChangeRate(productCompareData.profit, productExperimentData.profit)
                                });
                            });
                            
                            // 计算对比对象数据（基于产品类别）
                            let compareGroupExperimentSales = 0;
                            let compareGroupCompareSales = 0;
                            let compareGroupExperimentProfit = 0;
                            let compareGroupCompareProfit = 0;
                            
                            // 获取属于选中品类的所有产品
                            const compareProducts = productOptions.filter(product => 
                                selectedCompareProductCategories.includes(product.group)
                            );
                            
                            compareProducts.forEach(product => {
                                // 排除实验产品
                                if (!selectedProducts.some(p => p.id === product.id)) {
                                    const productExperimentData = calculatePeriodDataForProduct(
                                        product.id,
                                        experimentPeriod[0], 
                                        experimentPeriod[1]
                                    );
                                    
                                    const productCompareData = calculatePeriodDataForProduct(
                                        product.id,
                                        comparePeriod[0], 
                                        comparePeriod[1]
                                    );
                                    
                                    compareGroupExperimentSales += productExperimentData.sales;
                                    compareGroupCompareSales += productCompareData.sales;
                                    compareGroupExperimentProfit += productExperimentData.profit;
                                    compareGroupCompareProfit += productCompareData.profit;
                                    
                                    // 添加对比产品详情
                                    result.compareObjectDetails.push({
                                        name: product.name,
                                        experimentSales: productExperimentData.sales,
                                        compareSales: productCompareData.sales,
                                        experimentProfit: productExperimentData.profit,
                                        compareProfit: productCompareData.profit,
                                        salesGrowthRate: calculateChangeRate(productCompareData.sales, productExperimentData.sales),
                                        profitGrowthRate: calculateChangeRate(productCompareData.profit, productExperimentData.profit)
                                    });
                                }
                            });
                            
                            // 计算增长率
                            const experimentGroupSalesGrowthRate = calculateChangeRate(experimentGroupCompareSales, experimentGroupExperimentSales);
                            const compareGroupSalesGrowthRate = calculateChangeRate(compareGroupCompareSales, compareGroupExperimentSales);
                            const experimentGroupProfitGrowthRate = calculateChangeRate(experimentGroupCompareProfit, experimentGroupExperimentProfit);
                            const compareGroupProfitGrowthRate = calculateChangeRate(compareGroupCompareProfit, compareGroupExperimentProfit);
                            
                            // 计算相对增长百分点
                            const relativeSalesGrowth = (experimentGroupSalesGrowthRate - compareGroupSalesGrowthRate).toFixed(1);
                            const relativeProfitGrowth = (experimentGroupProfitGrowthRate - compareGroupProfitGrowthRate).toFixed(1);
                            
                            // 格式化显示
                            result.salesCompare = `${experimentGroupSalesGrowthRate}%/${compareGroupSalesGrowthRate}% ${parseFloat(relativeSalesGrowth) >= 0 ? '+' : ''}${relativeSalesGrowth}`;
                            result.profitCompare = `${experimentGroupProfitGrowthRate}%/${compareGroupProfitGrowthRate}% ${parseFloat(relativeProfitGrowth) >= 0 ? '+' : ''}${relativeProfitGrowth}`;
                            
                            // 确定对比对象名称
                            if (selectedCompareProductCategories.length > 0) {
                                experimentInfo.compareObject = selectedCompareProductCategories.map(cat => {
                                    const category = productCategoryOptions.find(c => c.id === cat);
                                    return category ? category.name : cat;
                                }).join(', ');
                            }
                        }
                    }
                    
                    resolve({ result, experimentInfo });
                }, 1500); // 模拟1.5秒计算时间
            });
        }
        
        // 计算指定时间段内的门店数据
        function calculatePeriodDataForStore(storeId, startDate, endDate) {
            let totalSales = 0;
            let totalProfit = 0;
            
            if (historicalSalesData.stores[storeId]) {
                const storeData = historicalSalesData.stores[storeId];
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // 计算时间段内的数据
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    const dateStr = formatDateForData(date);
                    if (storeData[dateStr]) {
                        totalSales += storeData[dateStr].sales;
                        totalProfit += storeData[dateStr].profit;
                    }
                }
            }
            
            // 如果没有数据，生成模拟数据
            if (totalSales === 0) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // 基于门店ID生成不同规模的数据
                const baseSales = storeId * 5000;
                totalSales = days * (baseSales + Math.floor(Math.random() * 5000));
                totalProfit = Math.floor(totalSales * 0.3);
            }
            
            const margin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            return {
                sales: totalSales,
                profit: totalProfit,
                margin: Math.round(margin * 10) / 10
            };
        }
        
        // 计算指定时间段内的产品数据
        function calculatePeriodDataForProduct(productId, startDate, endDate) {
            let totalSales = 0;
            let totalProfit = 0;
            
            if (historicalSalesData.products[productId]) {
                const productData = historicalSalesData.products[productId];
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // 计算时间段内的数据
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    const dateStr = formatDateForData(date);
                    if (productData[dateStr]) {
                        totalSales += productData[dateStr].sales;
                        totalProfit += productData[dateStr].profit;
                    }
                }
            }
            
            // 如果没有数据，生成模拟数据
            if (totalSales === 0) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // 基于产品ID生成不同规模的数据
                const baseSales = (productId % 100) * 100;
                totalSales = days * (baseSales + Math.floor(Math.random() * 200));
                totalProfit = Math.floor(totalSales * 0.3);
            }
            
            const margin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            return {
                sales: totalSales,
                profit: totalProfit,
                margin: Math.round(margin * 10) / 10
            };
        }
        
        // 格式化日期用于数据查询
        function formatDateForData(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 保存实验
        async function saveExperiment() {
            // 获取表单数据
            const title = document.getElementById('experimentTitle').value;
            const dimension = document.querySelector('input[name="dimension"]:checked').value;
            
            // 验证数据
            if (!title.trim()) {
                alert('请输入实验标题');
                return;
            }
            
            // 验证选择对象
            if (dimension === 'store' && selectedStores.length === 0) {
                alert('请选择门店');
                return;
            }
            
            if (dimension === 'product' && selectedProducts.length === 0) {
                alert('请选择产品');
                return;
            }
            
            // 维度对比需要验证对比对象
            if (currentCompareType === 'dimension') {
                if (dimension === 'store' && selectedCompareStores.length === 0) {
                    alert('请选择对比门店');
                    return;
                }
                
                if (dimension === 'product' && selectedCompareProductCategories.length === 0) {
                    alert('请选择对比产品类别');
                    return;
                }
            }
            
            // 显示加载动画
            formLoading.classList.add('active');
            
            let experimentInfo;
            
            if (currentCompareType === 'time') {
                // 时间对比
                const experimentStartDate = document.getElementById('experimentStartDate').value;
                const experimentEndDate = document.getElementById('experimentEndDate').value;
                const compareStartDate = document.getElementById('compareStartDate').value;
                const compareEndDate = document.getElementById('compareEndDate').value;
                
                if (!experimentStartDate || !experimentEndDate || !compareStartDate || !compareEndDate) {
                    alert('请填写完整的实验周期和对比周期');
                    formLoading.classList.remove('active');
                    return;
                }
                
                experimentInfo = {
                    dimension: dimension,
                    selectedStores: selectedStores,
                    selectedProducts: selectedProducts,
                    compareType: 'time',
                    experimentPeriod: `${formatDate(experimentStartDate)} 至 ${formatDate(experimentEndDate)}`,
                    comparePeriod: `${formatDate(compareStartDate)} 至 ${formatDate(compareEndDate)}`,
                    compareObject: '时间对比'
                };
            } else {
                // 维度对比
                const experimentStartDate = document.getElementById('dimensionExperimentStartDate').value;
                const experimentEndDate = document.getElementById('dimensionExperimentEndDate').value;
                
                if (!experimentStartDate || !experimentEndDate) {
                    alert('请填写完整的实验周期');
                    formLoading.classList.remove('active');
                    return;
                }
                
                // 设置对比周期为实验周期前一周
                const expStartDate = new Date(experimentStartDate);
                const expEndDate = new Date(experimentEndDate);
                const periodDays = Math.floor((expEndDate - expStartDate) / (1000 * 60 * 60 * 24)) + 1;
                
                const compareStart = new Date(expStartDate);
                compareStart.setDate(compareStart.getDate() - periodDays);
                const compareEnd = new Date(expStartDate);
                compareEnd.setDate(compareEnd.getDate() - 1);
                
                experimentInfo = {
                    dimension: dimension,
                    selectedStores: selectedStores,
                    selectedProducts: selectedProducts,
                    selectedCompareStores: selectedCompareStores,
                    selectedCompareProductCategories: selectedCompareProductCategories,
                    compareType: 'dimension',
                    experimentPeriod: `${formatDate(experimentStartDate)} 至 ${formatDate(experimentEndDate)}`,
                    comparePeriod: `${formatDate(compareStart)} 至 ${formatDate(compareEnd)}`,
                    compareObject: dimension === 'store' ? 
                        selectedCompareStores.map(store => store.name).join(', ') :
                        selectedCompareProductCategories.map(cat => {
                            const category = productCategoryOptions.find(c => c.id === cat);
                            return category ? category.name : cat;
                        }).join(', ')
                };
            }
            
            try {
                // 模拟计算实验数据
                const { result, experimentInfo: updatedExperimentInfo } = await calculateExperimentData(experimentInfo);
                
                // 创建实验对象
                const experiment = {
                    id: editingExperimentId || experimentData.length + 1,
                    title: title,
                    dimension: dimension,
                    objectType: dimension === 'store' ? '门店' : '产品',
                    objectNames: dimension === 'store' ? 
                        selectedStores.map(store => store.name) : 
                        selectedProducts.map(product => product.name),
                    ...updatedExperimentInfo,
                    salesCompare: result.salesCompare,
                    profitCompare: result.profitCompare,
                    storeContribution: result.storeContribution,
                    objectDetails: result.objectDetails,
                    compareObjectDetails: result.compareObjectDetails || []
                };
                
                // 添加或更新实验数据
                if (editingExperimentId) {
                    // 更新现有实验
                    const index = experimentData.findIndex(exp => exp.id === editingExperimentId);
                    if (index !== -1) {
                        experimentData[index] = experiment;
                    }
                } else {
                    // 添加新实验
                    experimentData.push(experiment);
                }
                
                // 更新表格
                renderExperimentTable();
                
                // 关闭弹窗
                experimentFormModal.classList.remove('active');
                formLoading.classList.remove('active');
                
                // 显示成功消息
                alert(`实验"${title}"已成功${editingExperimentId ? '更新' : '添加'}！`);
            } catch (error) {
                console.error('计算实验数据时出错:', error);
                alert('计算实验数据时出错，请稍后重试');
                formLoading.classList.remove('active');
            }
        }

        // 编辑实验
        function editExperiment(experimentId) {
            const experiment = experimentData.find(exp => exp.id === experimentId);
            if (!experiment) return;
            
            editingExperimentId = experimentId;
            formModalTitle.textContent = '编辑实验记录';
            
            // 填充表单数据
            document.getElementById('experimentTitle').value = experiment.title;
            
            // 设置维度
            if (experiment.dimension === 'store') {
                document.getElementById('dimensionStore').checked = true;
                currentDimension = 'store';
                
                // 设置门店选择
                selectedStores = experiment.objectNames.map(name => {
                    return storeOptions.find(opt => opt.name === name) || { id: Date.now(), name: name };
                });
            } else {
                document.getElementById('dimensionProduct').checked = true;
                currentDimension = 'product';
                
                // 设置产品选择
                selectedProducts = experiment.objectNames.map(name => {
                    return productOptions.find(opt => opt.name === name) || { id: Date.now(), name: name };
                });
            }
            
            // 设置对比类型
            currentCompareType = experiment.compareType;
            switchCompareType(experiment.compareType);
            
            if (experiment.compareType === 'time') {
                // 设置日期
                const experimentPeriodParts = experiment.experimentPeriod.split(' 至 ');
                document.getElementById('experimentStartDate').value = parseDateString(experimentPeriodParts[0]);
                document.getElementById('experimentEndDate').value = parseDateString(experimentPeriodParts[1]);
                
                const comparePeriodParts = experiment.comparePeriod.split(' 至 ');
                document.getElementById('compareStartDate').value = parseDateString(comparePeriodParts[0]);
                document.getElementById('compareEndDate').value = parseDateString(comparePeriodParts[1]);
            } else {
                // 维度对比
                const experimentPeriodParts = experiment.experimentPeriod.split(' 至 ');
                document.getElementById('dimensionExperimentStartDate').value = parseDateString(experimentPeriodParts[0]);
                document.getElementById('dimensionExperimentEndDate').value = parseDateString(experimentPeriodParts[1]);
                
                // 设置对比对象
                if (experiment.dimension === 'store') {
                    // 门店维度对比
                    selectedCompareStores = experiment.compareObject.split(', ').map(name => {
                        return storeOptions.find(opt => opt.name === name) || { id: Date.now(), name: name };
                    });
                } else {
                    // 产品维度对比
                    selectedCompareProductCategories = experiment.compareObject.split(', ').map(name => {
                        const category = productCategoryOptions.find(c => c.name === name);
                        return category ? category.id : name;
                    });
                }
            }
            
            // 更新UI
            updateSelectionSections();
            updateSelectedCounts();
            updateSelectedCompareCounts();
            
            // 显示表单弹窗
            experimentFormModal.classList.add('active');
        }

        // 删除实验
        function deleteExperiment(experimentId) {
            if (!confirm('确定要删除这个实验记录吗？此操作不可撤销。')) {
                return;
            }
            
            const index = experimentData.findIndex(exp => exp.id === experimentId);
            if (index !== -1) {
                experimentData.splice(index, 1);
                renderExperimentTable();
                alert('实验记录已删除');
            }
        }

        // 显示实验对象详情弹窗
        function showObjectDetailModal(experimentId) {
            const experiment = experimentData.find(exp => exp.id === experimentId);
            if (!experiment) return;
            
            detailModalTitle.textContent = `${experiment.title} - 实验详情`;
            
            let detailsHTML = '';
            
            // 实验基本信息
            detailsHTML += `
                <div class="detail-item">
                    <div class="detail-label">实验标题</div>
                    <div class="detail-value">${experiment.title}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">实验对象</div>
                    <div class="detail-value">${experiment.objectType}: ${experiment.objectNames.join(', ')}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">实验周期</div>
                    <div class="detail-value">${experiment.experimentPeriod}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">对比${experiment.compareType === 'time' ? '周期' : '对象'}</div>
                    <div class="detail-value">${experiment.compareObject}</div>
                </div>
                ${experiment.compareType === 'time' ? `
                <div class="detail-item">
                    <div class="detail-label">对比周期</div>
                    <div class="detail-value">${experiment.comparePeriod}</div>
                </div>
                ` : ''}
                <div class="detail-item">
                    <div class="detail-label">销额对比</div>
                    <div class="detail-value">${experiment.salesCompare}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">毛利额对比</div>
                    <div class="detail-value">${experiment.profitCompare}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">门店贡献对比</div>
                    <div class="detail-value">${experiment.storeContribution}</div>
                </div>
            `;
            
            // 实验对象详情表格
            if (experiment.objectDetails && experiment.objectDetails.length > 0) {
                detailsHTML += `
                    <div class="detail-item">
                        <div class="detail-label">实验对象详情</div>
                        <table class="object-detail-table">
                            <thead>
                                <tr>
                                    <th>${experiment.objectType}名称</th>
                                    <th>实验期销额</th>
                                    <th>对比期销额</th>
                                    <th>销额增长率</th>
                                    <th>实验期毛利额</th>
                                    <th>对比期毛利额</th>
                                    <th>毛利额增长率</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                experiment.objectDetails.forEach(detail => {
                    const salesChangeClass = detail.salesGrowthRate >= 0 ? 'positive' : 'negative';
                    const profitChangeClass = detail.profitGrowthRate >= 0 ? 'positive' : 'negative';
                    
                    const salesChangeSign = detail.salesGrowthRate >= 0 ? '+' : '';
                    const profitChangeSign = detail.profitGrowthRate >= 0 ? '+' : '';
                    
                    detailsHTML += `
                        <tr>
                            <td>${detail.name}</td>
                            <td>¥${detail.experimentSales.toLocaleString()}</td>
                            <td>¥${detail.compareSales.toLocaleString()}</td>
                            <td class="${salesChangeClass}">${salesChangeSign}${detail.salesGrowthRate}%</td>
                            <td>¥${detail.experimentProfit.toLocaleString()}</td>
                            <td>¥${detail.compareProfit.toLocaleString()}</td>
                            <td class="${profitChangeClass}">${profitChangeSign}${detail.profitGrowthRate}%</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // 对比对象详情表格（仅维度对比）
            if (experiment.compareType === 'dimension' && experiment.compareObjectDetails && experiment.compareObjectDetails.length > 0) {
                detailsHTML += `
                    <div class="detail-item">
                        <div class="detail-label">对比对象详情</div>
                        <table class="object-detail-table">
                            <thead>
                                <tr>
                                    <th>对比对象名称</th>
                                    <th>实验期销额</th>
                                    <th>对比期销额</th>
                                    <th>销额增长率</th>
                                    <th>实验期毛利额</th>
                                    <th>对比期毛利额</th>
                                    <th>毛利额增长率</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                experiment.compareObjectDetails.forEach(detail => {
                    const salesChangeClass = detail.salesGrowthRate >= 0 ? 'positive' : 'negative';
                    const profitChangeClass = detail.profitGrowthRate >= 0 ? 'positive' : 'negative';
                    
                    const salesChangeSign = detail.salesGrowthRate >= 0 ? '+' : '';
                    const profitChangeSign = detail.profitGrowthRate >= 0 ? '+' : '';
                    
                    detailsHTML += `
                        <tr>
                            <td>${detail.name}</td>
                            <td>¥${detail.experimentSales.toLocaleString()}</td>
                            <td>¥${detail.compareSales.toLocaleString()}</td>
                            <td class="${salesChangeClass}">${salesChangeSign}${detail.salesGrowthRate}%</td>
                            <td>¥${detail.experimentProfit.toLocaleString()}</td>
                            <td>¥${detail.compareProfit.toLocaleString()}</td>
                            <td class="${profitChangeClass}">${profitChangeSign}${detail.profitGrowthRate}%</td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            detailModalBody.innerHTML = detailsHTML;
            detailModal.classList.add('active');
        }

        // 显示实验详情弹窗（点击实验标题）
        function showExperimentDetailModal(experimentId) {
            // 这里可以显示更详细的信息，与showObjectDetailModal类似
            showObjectDetailModal(experimentId);
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // 辅助函数：解析日期字符串
        function parseDateString(dateString) {
            // 假设日期格式为 YYYY-MM-DD
            return dateString;
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
