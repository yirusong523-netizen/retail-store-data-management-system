<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验数据记录系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .header h1 i {
            margin-right: 10px;
        }
        
        .add-btn {
            background-color: #fff;
            color: #1890ff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .add-btn:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(24, 144, 255, 0.2);
        }
        
        .add-btn i {
            margin-right: 8px;
        }
        
        .content-area {
            padding: 25px;
        }
        
        .content-area h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-results {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
            margin-top: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background-color: #fafafa;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
            white-space: nowrap;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            vertical-align: top;
        }
        
        tr:hover {
            background-color: #fafafa;
        }
        
        .experiment-title {
            font-weight: 600;
            color: #1890ff;
            cursor: pointer;
        }
        
        .object-link {
            color: #1890ff;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }
        
        .period-cell {
            line-height: 1.4;
            white-space: nowrap;
        }
        
        .data-compare-cell {
            line-height: 1.6;
        }
        
        .compare-value {
            display: block;
            margin-bottom: 4px;
        }
        
        .positive {
            color: #f5222d; /* 红色表示增长 */
            font-weight: 600;
        }
        
        .negative {
            color: #52c41a; /* 绿色表示下降 */
            font-weight: 500;
        }
        
        .change-rate {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #fafafa;
            display: inline-block;
            margin-top: 4px;
        }
        
        .positive .change-rate {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
        }
        
        .negative .change-rate {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .delete-btn:hover {
            background-color: #fff1f0;
            border-color: #f5222d;
            color: #f5222d;
        }
        
        /* 合计行样式 */
        .summary-row {
            background-color: #fafafa;
            font-weight: 600;
            color: #333;
        }
        
        .summary-row td {
            border-top: 2px solid #e8e8e8;
            border-bottom: none;
            padding: 16px 12px;
        }
        
        .summary-label {
            color: #666;
            font-weight: 600;
        }
        
        .summary-value {
            color: #1890ff;
        }
        
        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }
        
        .detail-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .detail-value {
            color: #333;
            font-size: 15px;
        }
        
        .object-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .object-detail-table th {
            background-color: #fafafa;
            padding: 10px;
            font-weight: 600;
            color: #666;
            border: 1px solid #e8e8e8;
        }
        
        .object-detail-table td {
            padding: 10px;
            border: 1px solid #f0f0f0;
            text-align: center;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 8px;
        }
        
        .selection-panel {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .selection-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .selection-item:hover {
            background-color: #f5f5f5;
        }
        
        .selection-item input {
            margin-right: 10px;
        }
        
        .selected-count {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .clear-btn {
            background: none;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .save-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 24px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: white;
            color: #666;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 10px 24px;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #d9d9d9;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .compare-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .compare-type-btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .compare-type-btn.active {
            background-color: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
            font-weight: 500;
        }
        
        .compare-data-section {
            display: none;
        }
        
        .compare-data-section.active {
            display: block;
        }
        
        .explanation {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .explanation i {
            color: #52c41a;
            margin-right: 8px;
        }
        
        .info-message {
            background-color: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .info-message i {
            color: #1890ff;
            margin-right: 8px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading.active {
            display: block;
        }
        
        .loading i {
            margin-right: 8px;
            color: #1890ff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 门店*产品选择样式 */
        .store-product-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .store-selection, .product-selection {
            flex: 1;
        }
        
        .store-selection h4, .product-selection h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .store-product-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #fafafa;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }
        
        .store-product-info p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .store-product-info strong {
            color: #1890ff;
        }
        
        .step-indicator {
            display: flex;
            margin-bottom: 15px;
            position: relative;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #999;
            position: relative;
            background-color: #fafafa;
            border: 1px solid #e8e8e8;
        }
        
        .step:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .step:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .step.active {
            background-color: #e6f7ff;
            color: #1890ff;
            border-color: #1890ff;
        }
        
        .step.completed {
            background-color: #f6ffed;
            color: #52c41a;
            border-color: #b7eb8f;
        }
        
        /* 利润额对比样式 */
        .profit-margin-cell {
            line-height: 1.6;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row, .data-input-group, .store-product-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .search-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1><i class="fas fa-clipboard-list"></i> 实验数据记录</h1>
            <button class="add-btn" id="addExperimentBtn">
                <i class="fas fa-plus"></i> 添加实验记录
            </button>
        </div>
        
        <!-- 内容区域 -->
        <div class="content-area">
            <h2>
                <span><i class="fas fa-table"></i> 实验记录表</span>
                <span id="experimentCount" style="font-size: 14px; color: #666; font-weight: normal;"></span>
            </h2>
            
            <!-- 搜索框 -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="搜索实验标题...">
                </div>
                <button class="cancel-btn" id="clearSearchBtn">清除搜索</button>
            </div>
            <div class="search-results" id="searchResults"></div>
            
            <div class="table-container">
                <table id="experimentTable">
                    <thead>
                        <tr>
                            <th>实验标题</th>
                            <th>实验对象</th>
                            <th>实验周期</th>
                            <th>对比周期/对照组</th>
                            <th>销额对比</th>
                            <th>毛利额对比</th>
                            <th>利润额对比</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="experimentTableBody">
                        <!-- 数据通过JavaScript动态生成 -->
                    </tbody>
                    <tfoot id="experimentTableFooter">
                        <!-- 合计行通过JavaScript动态生成 -->
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑实验记录表单弹窗 -->
    <div class="modal" id="experimentFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="formModalTitle">添加实验记录</h3>
                <button class="close-btn" id="closeFormModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="experimentForm">
                    <div class="form-group">
                        <label>1. 选择维度类型</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="dimensionStore" name="dimension" value="store" checked>
                                <label for="dimensionStore">门店</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="dimensionProduct" name="dimension" value="product">
                                <label for="dimensionProduct">产品</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="dimensionStoreProduct" name="dimension" value="store_product">
                                <label for="dimensionStoreProduct">门店*产品</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 门店选择 -->
                    <div id="storeSelectionSection" class="form-group" style="display: none;">
                        <label>2. 选择门店</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="storeSearch" placeholder="搜索门店...">
                        </div>
                        
                        <div class="selection-panel" id="storeSelectionPanel">
                            <!-- 选项通过JavaScript动态生成 -->
                        </div>
                        
                        <div class="selected-count">
                            已选择门店: <span id="selectedStoreCount">0</span>个
                            <button type="button" class="clear-btn" id="clearStoreSelection">清除选择</button>
                        </div>
                    </div>
                    
                    <!-- 产品选择 -->
                    <div id="productSelectionSection" class="form-group" style="display: none;">
                        <label>3. 选择产品</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="productSearch" placeholder="搜索产品...">
                        </div>
                        
                        <div class="selection-panel" id="productSelectionPanel">
                            <!-- 选项通过JavaScript动态生成 -->
                        </div>
                        
                        <div class="selected-count">
                            已选择产品: <span id="selectedProductCount">0</span>个
                            <button type="button" class="clear-btn" id="clearProductSelection">清除选择</button>
                        </div>
                    </div>
                    
                    <!-- 门店*产品组合选择 -->
                    <div id="storeProductSelectionSection" class="form-group" style="display: none;">
                        <label>2. 选择门店*产品组合</label>
                        <div class="step-indicator">
                            <div class="step active" id="step1">选择门店</div>
                            <div class="step" id="step2">选择产品</div>
                        </div>
                        
                        <div class="store-product-container">
                            <div class="store-selection" id="storeProductStoreSelection">
                                <h4>选择门店</h4>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="storeProductStoreSearch" placeholder="搜索门店...">
                                </div>
                                
                                <div class="selection-panel" id="storeProductStorePanel">
                                    <!-- 选项通过JavaScript动态生成 -->
                                </div>
                                
                                <div class="selected-count">
                                    已选择门店: <span id="selectedStoreProductStoreCount">0</span>个
                                    <button type="button" class="clear-btn" id="clearStoreProductStoreSelection">清除选择</button>
                                </div>
                            </div>
                            
                            <div class="product-selection" id="storeProductProductSelection" style="display: none;">
                                <h4>选择产品</h4>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="storeProductProductSearch" placeholder="搜索产品...">
                                </div>
                                
                                <div class="selection-panel" id="storeProductProductPanel">
                                    <!-- 选项通过JavaScript动态生成 -->
                                </div>
                                
                                <div class="selected-count">
                                    已选择产品: <span id="selectedStoreProductProductCount">0</span>个
                                    <button type="button" class="clear-btn" id="clearStoreProductProductSelection">清除选择</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="store-product-info">
                            <p>您已选择: <strong><span id="selectedStoreProductInfo">0个门店 × 0个产品 = 0种组合</span></strong></p>
                        </div>
                        
                        <div class="form-row" style="margin-top: 10px;">
                            <button type="button" class="cancel-btn" id="nextStepBtn" style="display: none;">下一步：选择产品</button>
                            <button type="button" class="cancel-btn" id="prevStepBtn" style="display: none;">上一步：选择门店</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>4. 实验标题</label>
                        <input type="text" id="experimentTitle" placeholder="输入实验标题..." required>
                    </div>
                    
                    <div class="form-group">
                        <label>5. 对比类型</label>
                        <div class="compare-type-selector">
                            <button type="button" class="compare-type-btn active" data-compare-type="time">时间对比</button>
                            <button type="button" class="compare-type-btn" data-compare-type="dimension">维度对比</button>
                        </div>
                    </div>
                    
                    <!-- 时间对比部分 -->
                    <div id="timeCompareSection" class="compare-data-section active">
                        <div class="explanation">
                            <i class="fas fa-info-circle"></i>
                            <strong>时间对比说明：</strong>对比实验对象实验前后的业绩数据。系统将根据历史数据自动计算实验前后的业绩指标。
                        </div>
                        
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>实验周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="experimentStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="experimentEndDate" required>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <label>对比周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="compareStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="compareEndDate" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 维度对比部分 -->
                    <div id="dimensionCompareSection" class="compare-data-section">
                        <div class="explanation">
                            <i class="fas fa-info-circle"></i>
                            <strong>维度对比说明：</strong>对比实验对象和公司内其他门店、产品的业绩数据。系统将根据同一时间段的数据进行对比分析。
                        </div>
                        
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>实验周期</label>
                                    <div class="input-row">
                                        <label>开始日期</label>
                                        <input type="date" id="dimensionExperimentStartDate" required>
                                    </div>
                                    <div class="input-row">
                                        <label>结束日期</label>
                                        <input type="date" id="dimensionExperimentEndDate" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-message">
                            <i class="fas fa-database"></i>
                            <strong>数据来源：</strong>系统将自动从销售数据库中获取实验对象和对比对象在同一时间段的业绩数据，并进行对比分析。
                        </div>
                    </div>
                    
                    <div class="loading" id="formLoading">
                        <i class="fas fa-spinner"></i> 正在计算实验数据，请稍候...
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" id="cancelForm">取消</button>
                        <button type="submit" class="save-btn">保存实验</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 详情弹窗 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">详情</h3>
                <button class="close-btn" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- 详情内容通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 模拟历史销售数据（实际应用中应从数据库获取）
        const historicalSalesData = {
            // 门店历史销售数据（按日期和门店ID）
            stores: {
                1: { // 北京朝阳店
                    "2024-01-08": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2024-01-09": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2024-01-10": { sales: 36000, profit: 10800, margin: 30.0 },
                    "2024-01-11": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2024-01-12": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2024-01-13": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2024-01-14": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2024-01-15": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2024-01-16": { sales: 37000, profit: 11100, margin: 30.0 },
                    "2024-01-17": { sales: 39000, profit: 11700, margin: 30.0 },
                    "2024-01-18": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2024-01-19": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2024-01-20": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2024-01-21": { sales: 48000, profit: 14400, margin: 30.0 }
                },
                2: { // 上海徐汇店
                    "2024-01-08": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2024-01-09": { sales: 44000, profit: 13200, margin: 30.0 },
                    "2024-01-10": { sales: 46000, profit: 13800, margin: 30.0 },
                    "2024-01-11": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2024-01-12": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2024-01-13": { sales: 52000, profit: 15600, margin: 30.0 },
                    "2024-01-14": { sales: 55000, profit: 16500, margin: 30.0 },
                    "2024-01-15": { sales: 45000, profit: 13500, margin: 30.0 },
                    "2024-01-16": { sales: 47000, profit: 14100, margin: 30.0 },
                    "2024-01-17": { sales: 49000, profit: 14700, margin: 30.0 },
                    "2024-01-18": { sales: 51000, profit: 15300, margin: 30.0 },
                    "2024-01-19": { sales: 48000, profit: 14400, margin: 30.0 },
                    "2024-01-20": { sales: 55000, profit: 16500, margin: 30.0 },
                    "2024-01-21": { sales: 58000, profit: 17400, margin: 30.0 }
                },
                3: { // 广州天河店
                    "2024-01-08": { sales: 28000, profit: 8400, margin: 30.0 },
                    "2024-01-09": { sales: 30000, profit: 9000, margin: 30.0 },
                    "2024-01-10": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2024-01-11": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2024-01-12": { sales: 31000, profit: 9300, margin: 30.0 },
                    "2024-01-13": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2024-01-14": { sales: 41000, profit: 12300, margin: 30.0 },
                    "2024-01-15": { sales: 32000, profit: 9600, margin: 30.0 },
                    "2024-01-16": { sales: 34000, profit: 10200, margin: 30.0 },
                    "2024-01-17": { sales: 36000, profit: 10800, margin: 30.0 },
                    "2024-01-18": { sales: 38000, profit: 11400, margin: 30.0 },
                    "2024-01-19": { sales: 35000, profit: 10500, margin: 30.0 },
                    "2024-01-20": { sales: 42000, profit: 12600, margin: 30.0 },
                    "2024-01-21": { sales: 45000, profit: 13500, margin: 30.0 }
                }
            },
            // 产品历史销售数据（按日期和产品ID）
            products: {
                101: { // 可口可乐
                    "2024-01-08": { sales: 8000, profit: 2400, margin: 30.0 },
                    "2024-01-09": { sales: 8500, profit: 2550, margin: 30.0 },
                    "2024-01-10": { sales: 9000, profit: 2700, margin: 30.0 },
                    "2024-01-11": { sales: 9500, profit: 2850, margin: 30.0 },
                    "2024-01-12": { sales: 8800, profit: 2640, margin: 30.0 },
                    "2024-01-13": { sales: 11000, profit: 3300, margin: 30.0 },
                    "2024-01-14": { sales: 12000, profit: 3600, margin: 30.0 },
                    "2024-01-15": { sales: 9000, profit: 2700, margin: 30.0 },
                    "2024-01-16": { sales: 9500, profit: 2850, margin: 30.0 },
                    "2024-01-17": { sales: 10000, profit: 3000, margin: 30.0 },
                    "2024-01-18": { sales: 10500, profit: 3150, margin: 30.0 },
                    "2024-01-19": { sales: 9800, profit: 2940, margin: 30.0 },
                    "2024-01-20": { sales: 12500, profit: 3750, margin: 30.0 },
                    "2024-01-21": { sales: 13500, profit: 4050, margin: 30.0 }
                },
                102: { // 雪碧
                    "2024-01-08": { sales: 6000, profit: 1800, margin: 30.0 },
                    "2024-01-09": { sales: 6500, profit: 1950, margin: 30.0 },
                    "2024-01-10": { sales: 7000, profit: 2100, margin: 30.0 },
                    "2024-01-11": { sales: 7500, profit: 2250, margin: 30.0 },
                    "2024-01-12": { sales: 6800, profit: 2040, margin: 30.0 },
                    "2024-01-13": { sales: 9000, profit: 2700, margin: 30.0 },
                    "2024-01-14": { sales: 10000, profit: 3000, margin: 30.0 },
                    "2024-01-15": { sales: 7000, profit: 2100, margin: 30.0 },
                    "2024-01-16": { sales: 7500, profit: 2250, margin: 30.0 },
                    "2024-01-17": { sales: 8000, profit: 2400, margin: 30.0 },
                    "2024-01-18": { sales: 8500, profit: 2550, margin: 30.0 },
                    "2024-01-19": { sales: 7800, profit: 2340, margin: 30.0 },
                    "2024-01-20": { sales: 10500, profit: 3150, margin: 30.0 },
                    "2024-01-21": { sales: 11500, profit: 3450, margin: 30.0 }
                },
                103: { // 矿泉水
                    "2024-01-08": { sales: 4000, profit: 1200, margin: 30.0 },
                    "2024-01-09": { sales: 4500, profit: 1350, margin: 30.0 },
                    "2024-01-10": { sales: 5000, profit: 1500, margin: 30.0 },
                    "2024-01-11": { sales: 5500, profit: 1650, margin: 30.0 },
                    "2024-01-12": { sales: 4800, profit: 1440, margin: 30.0 },
                    "2024-01-13": { sales: 7000, profit: 2100, margin: 30.0 },
                    "2024-01-14": { sales: 8000, profit: 2400, margin: 30.0 },
                    "2024-01-15": { sales: 5000, profit: 1500, margin: 30.0 },
                    "2024-01-16": { sales: 5500, profit: 1650, margin: 30.0 },
                    "2024-01-17": { sales: 6000, profit: 1800, margin: 30.0 },
                    "2024-01-18": { sales: 6500, profit: 1950, margin: 30.0 },
                    "2024-01-19": { sales: 5800, profit: 1740, margin: 30.0 },
                    "2024-01-20": { sales: 8500, profit: 2550, margin: 30.0 },
                    "2024-01-21": { sales: 9500, profit: 2850, margin: 30.0 }
                }
            }
        };

        // 实验数据
        let experimentData = [
            {
                id: 1,
                title: "春节促销活动实验",
                dimension: "store",
                objectType: "门店",
                objectCount: 3,
                objectNames: ["北京朝阳店", "上海徐汇店", "广州天河店"],
                compareType: "time",
                experimentPeriod: "2024-01-15 至 2024-01-21",
                comparePeriod: "2024-01-08 至 2024-01-14",
                beforeData: { sales: 100000, profit: 30000, margin: 30.0 },
                afterData: { sales: 120000, profit: 36000, margin: 30.0 },
                objectDetails: [
                    { name: "北京朝阳店", beforeSales: 35000, afterSales: 42000, salesChange: 20.0, beforeProfit: 10500, afterProfit: 12600, profitChange: 20.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "上海徐汇店", beforeSales: 42000, afterSales: 50000, salesChange: 19.0, beforeProfit: 12600, afterProfit: 15000, profitChange: 19.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "广州天河店", beforeSales: 23000, afterSales: 28000, salesChange: 21.7, beforeProfit: 6900, afterProfit: 8400, profitChange: 21.7, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 }
                ]
            },
            {
                id: 2,
                title: "饮料品类促销实验",
                dimension: "product",
                objectType: "产品",
                objectCount: 2,
                objectNames: ["可口可乐", "雪碧"],
                compareType: "dimension",
                experimentPeriod: "2024-01-15 至 2024-01-21",
                compareObject: "饮料品类其他产品",
                beforeData: { sales: 45000, profit: 13500, margin: 30.0 },
                afterData: { sales: 55000, profit: 16500, margin: 30.0 },
                objectDetails: [
                    { name: "可口可乐", beforeSales: 25000, afterSales: 30000, salesChange: 20.0, beforeProfit: 7500, afterProfit: 9000, profitChange: 20.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "雪碧", beforeSales: 20000, afterSales: 25000, salesChange: 25.0, beforeProfit: 6000, afterProfit: 7500, profitChange: 25.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 }
                ]
            },
            {
                id: 3,
                title: "周末特价活动",
                dimension: "store",
                objectType: "门店",
                objectCount: 2,
                objectNames: ["北京朝阳店", "上海徐汇店"],
                compareType: "dimension",
                experimentPeriod: "2024-01-15 至 2024-01-21",
                compareObject: "公司其他门店",
                beforeData: { sales: 80000, profit: 24000, margin: 30.0 },
                afterData: { sales: 95000, profit: 28500, margin: 30.0 },
                objectDetails: [
                    { name: "北京朝阳店", beforeSales: 35000, afterSales: 42000, salesChange: 20.0, beforeProfit: 10500, afterProfit: 12600, profitChange: 20.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "上海徐汇店", beforeSales: 45000, afterSales: 53000, salesChange: 17.8, beforeProfit: 13500, afterProfit: 15900, profitChange: 17.8, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 }
                ]
            },
            {
                id: 4,
                title: "饮料促销活动",
                dimension: "store_product",
                objectType: "门店*产品",
                storeCount: 2,
                productCount: 2,
                storeNames: ["北京朝阳店", "上海徐汇店"],
                productNames: ["可口可乐", "雪碧"],
                compareType: "time",
                experimentPeriod: "2024-01-15 至 2024-01-21",
                comparePeriod: "2024-01-08 至 2024-01-14",
                beforeData: { sales: 45000, profit: 13500, margin: 30.0 },
                afterData: { sales: 55000, profit: 16500, margin: 30.0 },
                objectDetails: [
                    { name: "北京朝阳店-可口可乐", beforeSales: 12000, afterSales: 15000, salesChange: 25.0, beforeProfit: 3600, afterProfit: 4500, profitChange: 25.0, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "北京朝阳店-雪碧", beforeSales: 9000, afterSales: 11000, salesChange: 22.2, beforeProfit: 2700, afterProfit: 3300, profitChange: 22.2, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "上海徐汇店-可口可乐", beforeSales: 13000, afterSales: 15000, salesChange: 15.4, beforeProfit: 3900, afterProfit: 4500, profitChange: 15.4, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 },
                    { name: "上海徐汇店-雪碧", beforeSales: 11000, afterSales: 14000, salesChange: 27.3, beforeProfit: 3300, afterProfit: 4200, profitChange: 27.3, beforeMargin: 30.0, afterMargin: 30.0, marginChange: 0.0 }
                ]
            }
        ];

        // 选择对象数据
        const storeOptions = [
            { id: 1, name: "北京朝阳店", group: "华北区" },
            { id: 2, name: "上海徐汇店", group: "华东区" },
            { id: 3, name: "广州天河店", group: "华南区" },
            { id: 4, name: "深圳南山店", group: "华南区" },
            { id: 5, name: "成都锦江店", group: "西南区" },
            { id: 6, name: "武汉江汉店", group: "华中区" },
            { id: 7, name: "南京鼓楼店", group: "华东区" },
            { id: 8, name: "西安雁塔店", group: "西北区" },
            { id: 9, name: "杭州西湖店", group: "华东区" },
            { id: 10, name: "苏州观前店", group: "华东区" }
        ];

        const productOptions = [
            { id: 101, name: "可口可乐", group: "饮料" },
            { id: 102, name: "雪碧", group: "饮料" },
            { id: 103, name: "矿泉水", group: "饮料" },
            { id: 104, name: "百事可乐", group: "饮料" },
            { id: 105, name: "芬达", group: "饮料" },
            { id: 106, name: "苏打水", group: "饮料" },
            { id: 107, name: "薯片", group: "零食" },
            { id: 108, name: "巧克力", group: "零食" },
            { id: 109, name: "饼干", group: "零食" },
            { id: 110, name: "坚果", group: "零食" }
        ];

        // DOM元素
        const experimentTableBody = document.getElementById('experimentTableBody');
        const experimentTableFooter = document.getElementById('experimentTableFooter');
        const experimentFormModal = document.getElementById('experimentFormModal');
        const detailModal = document.getElementById('detailModal');
        const addExperimentBtn = document.getElementById('addExperimentBtn');
        const closeFormModal = document.getElementById('closeFormModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const cancelForm = document.getElementById('cancelForm');
        const experimentForm = document.getElementById('experimentForm');
        const formModalTitle = document.getElementById('formModalTitle');
        const detailModalTitle = document.getElementById('detailModalTitle');
        const detailModalBody = document.getElementById('detailModalBody');
        const timeCompareSection = document.getElementById('timeCompareSection');
        const dimensionCompareSection = document.getElementById('dimensionCompareSection');
        const formLoading = document.getElementById('formLoading');
        const compareTypeButtons = document.querySelectorAll('.compare-type-btn');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchResults = document.getElementById('searchResults');
        const experimentCount = document.getElementById('experimentCount');
        
        // 维度选择相关
        const dimensionStore = document.getElementById('dimensionStore');
        const dimensionProduct = document.getElementById('dimensionProduct');
        const dimensionStoreProduct = document.getElementById('dimensionStoreProduct');
        
        // 门店选择相关
        const storeSelectionSection = document.getElementById('storeSelectionSection');
        const storeSearch = document.getElementById('storeSearch');
        const storeSelectionPanel = document.getElementById('storeSelectionPanel');
        const selectedStoreCount = document.getElementById('selectedStoreCount');
        const clearStoreSelection = document.getElementById('clearStoreSelection');
        
        // 产品选择相关
        const productSelectionSection = document.getElementById('productSelectionSection');
        const productSearch = document.getElementById('productSearch');
        const productSelectionPanel = document.getElementById('productSelectionPanel');
        const selectedProductCount = document.getElementById('selectedProductCount');
        const clearProductSelection = document.getElementById('clearProductSelection');
        
        // 门店*产品选择相关
        const storeProductSelectionSection = document.getElementById('storeProductSelectionSection');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const storeProductStoreSearch = document.getElementById('storeProductStoreSearch');
        const storeProductStorePanel = document.getElementById('storeProductStorePanel');
        const selectedStoreProductStoreCount = document.getElementById('selectedStoreProductStoreCount');
        const clearStoreProductStoreSelection = document.getElementById('clearStoreProductStoreSelection');
        const storeProductProductSelection = document.getElementById('storeProductProductSelection');
        const storeProductProductSearch = document.getElementById('storeProductProductSearch');
        const storeProductProductPanel = document.getElementById('storeProductProductPanel');
        const selectedStoreProductProductCount = document.getElementById('selectedStoreProductProductCount');
        const clearStoreProductProductSelection = document.getElementById('clearStoreProductProductSelection');
        const selectedStoreProductInfo = document.getElementById('selectedStoreProductInfo');
        const nextStepBtn = document.getElementById('nextStepBtn');
        const prevStepBtn = document.getElementById('prevStepBtn');

        // 当前选择的维度
        let currentDimension = 'store';
        // 当前选择的对象
        let selectedStores = [];
        let selectedProducts = [];
        // 当前编辑的实验ID (null表示新增)
        let editingExperimentId = null;
        // 当前对比类型
        let currentCompareType = 'time';
        // 门店*产品选择的当前步骤
        let currentStep = 1;
        // 当前搜索关键词
        let currentSearchKeyword = '';

        // 初始化页面
        function initPage() {
            renderExperimentTable();
            setupEventListeners();
            
            // 设置默认日期
            const today = new Date();
            const experimentStartDate = document.getElementById('experimentStartDate');
            const experimentEndDate = document.getElementById('experimentEndDate');
            
            // 设置实验开始日期为今天
            experimentStartDate.valueAsDate = today;
            
            // 设置实验结束日期为7天后
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 7);
            experimentEndDate.valueAsDate = endDate;
            
            // 维度对比的日期
            const dimensionExperimentStartDate = document.getElementById('dimensionExperimentStartDate');
            const dimensionExperimentEndDate = document.getElementById('dimensionExperimentEndDate');
            dimensionExperimentStartDate.valueAsDate = today;
            dimensionExperimentEndDate.valueAsDate = endDate;
            
            // 设置对比周期默认值为实验周期前7天
            const compareStartDate = document.getElementById('compareStartDate');
            const compareEndDate = document.getElementById('compareEndDate');
            
            const compareStart = new Date(today);
            compareStart.setDate(compareStart.getDate() - 7);
            const compareEnd = new Date(today);
            compareEnd.setDate(compareEnd.getDate() - 1);
            
            compareStartDate.valueAsDate = compareStart;
            compareEndDate.valueAsDate = compareEnd;
        }

        // 渲染实验表格
        function renderExperimentTable() {
            // 过滤实验数据
            let filteredExperiments = experimentData;
            
            if (currentSearchKeyword) {
                filteredExperiments = experimentData.filter(experiment => 
                    experiment.title.toLowerCase().includes(currentSearchKeyword.toLowerCase())
                );
            }
            
            experimentTableBody.innerHTML = '';
            
            if (filteredExperiments.length === 0) {
                experimentTableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <h3>暂无实验记录</h3>
                                <p>${currentSearchKeyword ? '未找到匹配的实验记录，请尝试其他搜索词' : '点击"添加实验记录"按钮创建第一个实验'}</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // 清空合计行
                experimentTableFooter.innerHTML = '';
                
                // 更新实验计数
                experimentCount.textContent = `(0条记录)`;
                searchResults.innerHTML = currentSearchKeyword ? 
                    `未找到包含"${currentSearchKeyword}"的实验记录` : 
                    '';
                    
                return;
            }
            
            // 计算合计数据
            let totalBeforeSales = 0;
            let totalAfterSales = 0;
            let totalBeforeProfit = 0;
            let totalAfterProfit = 0;
            let totalMarginChange = 0;
            let validMarginCount = 0;
            
            filteredExperiments.forEach(experiment => {
                // 计算变化率
                const salesChangeRate = calculateChangeRate(experiment.beforeData.sales, experiment.afterData.sales);
                const profitChangeRate = calculateChangeRate(experiment.beforeData.profit, experiment.afterData.profit);
                const marginChangeRate = calculateChangeRate(experiment.beforeData.margin, experiment.afterData.margin);
                
                // 确定变化率样式类（红色增长，绿色下降）
                const salesChangeClass = salesChangeRate >= 0 ? 'positive' : 'negative';
                const profitChangeClass = profitChangeRate >= 0 ? 'positive' : 'negative';
                const marginChangeClass = marginChangeRate >= 0 ? 'positive' : 'negative';
                
                // 变化率符号
                const salesChangeSign = salesChangeRate >= 0 ? '+' : '';
                const profitChangeSign = profitChangeRate >= 0 ? '+' : '';
                const marginChangeSign = marginChangeRate >= 0 ? '+' : '';
                
                // 确定对比周期/对照组显示
                let compareDisplay = '';
                if (experiment.compareType === 'time') {
                    compareDisplay = experiment.comparePeriod;
                } else {
                    compareDisplay = experiment.compareObject;
                }
                
                // 确定实验对象显示
                let objectDisplay = '';
                if (experiment.dimension === 'store_product') {
                    objectDisplay = `${experiment.objectType}(${experiment.storeCount}×${experiment.productCount})`;
                } else {
                    objectDisplay = `${experiment.objectType}(${experiment.objectCount})`;
                }
                
                // 累计合计数据
                totalBeforeSales += experiment.beforeData.sales;
                totalAfterSales += experiment.afterData.sales;
                totalBeforeProfit += experiment.beforeData.profit;
                totalAfterProfit += experiment.afterData.profit;
                totalMarginChange += marginChangeRate;
                validMarginCount++;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="experiment-title">${experiment.title}</div>
                    </td>
                    <td>
                        <span class="object-link" data-id="${experiment.id}" data-type="object">
                            ${objectDisplay}
                        </span>
                    </td>
                    <td class="period-cell">${experiment.experimentPeriod}</td>
                    <td class="period-cell">${compareDisplay}</td>
                    <td class="data-compare-cell ${salesChangeClass}">
                        <span class="compare-value">¥${experiment.beforeData.sales.toLocaleString()} / ¥${experiment.afterData.sales.toLocaleString()}</span>
                        <span class="change-rate">${salesChangeSign}${salesChangeRate}%</span>
                    </td>
                    <td class="data-compare-cell ${profitChangeClass}">
                        <span class="compare-value">¥${experiment.beforeData.profit.toLocaleString()} / ¥${experiment.afterData.profit.toLocaleString()}</span>
                        <span class="change-rate">${profitChangeSign}${profitChangeRate}%</span>
                    </td>
                    <td class="data-compare-cell ${marginChangeClass}">
                        <span class="compare-value">${experiment.beforeData.margin}% / ${experiment.afterData.margin}%</span>
                        <span class="change-rate">${marginChangeSign}${marginChangeRate}%</span>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="action-btn edit-btn" data-id="${experiment.id}">编辑</button>
                            <button class="action-btn delete-btn" data-id="${experiment.id}">删除</button>
                        </div>
                    </td>
                `;
                
                experimentTableBody.appendChild(row);
            });
            
            // 渲染合计行
            renderSummaryRow(totalBeforeSales, totalAfterSales, totalBeforeProfit, totalAfterProfit, totalMarginChange, validMarginCount);
            
            // 更新实验计数
            const totalCount = experimentData.length;
            const filteredCount = filteredExperiments.length;
            experimentCount.textContent = `(${filteredCount}条记录${currentSearchKeyword && filteredCount !== totalCount ? `，共${totalCount}条` : ''})`;
            
            // 更新搜索结果显示
            if (currentSearchKeyword) {
                searchResults.innerHTML = `找到 ${filteredCount} 条包含"<strong>${currentSearchKeyword}</strong>"的实验记录`;
            } else {
                searchResults.innerHTML = '';
            }
            
            // 添加事件监听器
            document.querySelectorAll('.object-link').forEach(link => {
                link.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    showObjectDetailModal(experimentId);
                });
            });
            
            document.querySelectorAll('.experiment-title').forEach(title => {
                title.addEventListener('click', function() {
                    const experimentId = parseInt(this.closest('tr').querySelector('.edit-btn').getAttribute('data-id'));
                    showExperimentDetailModal(experimentId);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    editExperiment(experimentId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const experimentId = parseInt(this.getAttribute('data-id'));
                    deleteExperiment(experimentId);
                });
            });
        }
        
        // 渲染合计行
        function renderSummaryRow(totalBeforeSales, totalAfterSales, totalBeforeProfit, totalAfterProfit, totalMarginChange, validMarginCount) {
            // 计算整体变化率
            const totalSalesChangeRate = calculateChangeRate(totalBeforeSales, totalAfterSales);
            const totalProfitChangeRate = calculateChangeRate(totalBeforeProfit, totalAfterProfit);
            const avgMarginChange = validMarginCount > 0 ? totalMarginChange / validMarginCount : 0;
            
            // 确定变化率样式类
            const salesChangeClass = totalSalesChangeRate >= 0 ? 'positive' : 'negative';
            const profitChangeClass = totalProfitChangeRate >= 0 ? 'positive' : 'negative';
            const marginChangeClass = avgMarginChange >= 0 ? 'positive' : 'negative';
            
            // 变化率符号
            const salesChangeSign = totalSalesChangeRate >= 0 ? '+' : '';
            const profitChangeSign = totalProfitChangeRate >= 0 ? '+' : '';
            const marginChangeSign = avgMarginChange >= 0 ? '+' : '';
            
            experimentTableFooter.innerHTML = `
                <tr class="summary-row">
                    <td class="summary-label">合计 (${experimentData.length}个实验)</td>
                    <td>--</td>
                    <td>--</td>
                    <td>--</td>
                    <td class="data-compare-cell ${salesChangeClass}">
                        <span class="compare-value">¥${totalBeforeSales.toLocaleString()} / ¥${totalAfterSales.toLocaleString()}</span>
                        <span class="change-rate">${salesChangeSign}${totalSalesChangeRate.toFixed(2)}%</span>
                    </td>
                    <td class="data-compare-cell ${profitChangeClass}">
                        <span class="compare-value">¥${totalBeforeProfit.toLocaleString()} / ¥${totalAfterProfit.toLocaleString()}</span>
                        <span class="change-rate">${profitChangeSign}${totalProfitChangeRate.toFixed(2)}%</span>
                    </td>
                    <td class="data-compare-cell ${marginChangeClass}">
                        <span class="change-rate">${marginChangeSign}${avgMarginChange.toFixed(2)}%</span>
                    </td>
                    <td>--</td>
                </tr>
            `;
        }

        // 计算变化率
        function calculateChangeRate(before, after) {
            if (before === 0) return 0;
            return Math.round(((after - before) / before) * 100 * 100) / 100;
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 添加实验按钮
            addExperimentBtn.addEventListener('click', () => {
                editingExperimentId = null;
                formModalTitle.textContent = '添加实验记录';
                resetForm();
                experimentFormModal.classList.add('active');
            });

            // 关闭表单弹窗
            closeFormModal.addEventListener('click', () => {
                experimentFormModal.classList.remove('active');
            });

            // 关闭详情弹窗
            closeDetailModal.addEventListener('click', () => {
                detailModal.classList.remove('active');
            });

            // 取消表单
            cancelForm.addEventListener('click', () => {
                experimentFormModal.classList.remove('active');
            });

            // 表单提交
            experimentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveExperiment();
            });

            // 维度选择变化
            document.querySelectorAll('input[name="dimension"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentDimension = this.value;
                    updateSelectionSections();
                    
                    // 重置选择
                    selectedStores = [];
                    selectedProducts = [];
                    updateStoreSelectionPanel();
                    updateProductSelectionPanel();
                    updateStoreProductStorePanel();
                    updateStoreProductProductPanel();
                    updateSelectedCounts();
                });
            });

            // 门店搜索框
            storeSearch.addEventListener('input', function() {
                updateStoreSelectionPanel();
            });
            
            // 产品搜索框
            productSearch.addEventListener('input', function() {
                updateProductSelectionPanel();
            });
            
            // 门店*产品门店搜索框
            storeProductStoreSearch.addEventListener('input', function() {
                updateStoreProductStorePanel();
            });
            
            // 门店*产品产品搜索框
            storeProductProductSearch.addEventListener('input', function() {
                updateStoreProductProductPanel();
            });

            // 清除门店选择
            clearStoreSelection.addEventListener('click', function() {
                selectedStores = [];
                updateSelectedCounts();
                updateStoreSelectionPanel();
            });
            
            // 清除产品选择
            clearProductSelection.addEventListener('click', function() {
                selectedProducts = [];
                updateSelectedCounts();
                updateProductSelectionPanel();
            });
            
            // 清除门店*产品门店选择
            clearStoreProductStoreSelection.addEventListener('click', function() {
                selectedStores = [];
                updateSelectedCounts();
                updateStoreProductStorePanel();
                updateStoreProductInfo();
            });
            
            // 清除门店*产品产品选择
            clearStoreProductProductSelection.addEventListener('click', function() {
                selectedProducts = [];
                updateSelectedCounts();
                updateStoreProductProductPanel();
                updateStoreProductInfo();
            });
            
            // 对比类型切换
            compareTypeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const compareType = this.getAttribute('data-compare-type');
                    switchCompareType(compareType);
                });
            });
            
            // 门店*产品下一步按钮
            nextStepBtn.addEventListener('click', function() {
                if (selectedStores.length === 0) {
                    alert('请先选择门店');
                    return;
                }
                
                currentStep = 2;
                step1.classList.remove('active');
                step1.classList.add('completed');
                step2.classList.add('active');
                
                storeProductStoreSelection.style.display = 'none';
                storeProductProductSelection.style.display = 'block';
                nextStepBtn.style.display = 'none';
                prevStepBtn.style.display = 'block';
                
                updateStoreProductProductPanel();
            });
            
            // 门店*产品上一步按钮
            prevStepBtn.addEventListener('click', function() {
                currentStep = 1;
                step1.classList.add('active');
                step1.classList.remove('completed');
                step2.classList.remove('active');
                
                storeProductStoreSelection.style.display = 'block';
                storeProductProductSelection.style.display = 'none';
                nextStepBtn.style.display = selectedStores.length > 0 ? 'block' : 'none';
                prevStepBtn.style.display = 'none';
            });
            
            // 搜索框输入事件
            searchInput.addEventListener('input', function() {
                currentSearchKeyword = this.value.trim();
                renderExperimentTable();
            });
            
            // 清除搜索按钮
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                currentSearchKeyword = '';
                renderExperimentTable();
            });
        }
        
        // 切换对比类型
        function switchCompareType(compareType) {
            currentCompareType = compareType;
            
            // 更新按钮状态
            compareTypeButtons.forEach(btn => {
                if (btn.getAttribute('data-compare-type') === compareType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 显示对应的数据输入部分
            if (compareType === 'time') {
                timeCompareSection.classList.add('active');
                dimensionCompareSection.classList.remove('active');
            } else {
                timeCompareSection.classList.remove('active');
                dimensionCompareSection.classList.add('active');
            }
        }
        
        // 更新选择区域显示
        function updateSelectionSections() {
            // 隐藏所有选择区域
            storeSelectionSection.style.display = 'none';
            productSelectionSection.style.display = 'none';
            storeProductSelectionSection.style.display = 'none';
            
            // 根据当前维度显示对应选择区域
            if (currentDimension === 'store') {
                storeSelectionSection.style.display = 'block';
                updateStoreSelectionPanel();
            } else if (currentDimension === 'product') {
                productSelectionSection.style.display = 'block';
                updateProductSelectionPanel();
            } else if (currentDimension === 'store_product') {
                storeProductSelectionSection.style.display = 'block';
                updateStoreProductStorePanel();
                
                // 重置步骤
                currentStep = 1;
                step1.classList.add('active');
                step1.classList.remove('completed');
                step2.classList.remove('active');
                storeProductStoreSelection.style.display = 'block';
                storeProductProductSelection.style.display = 'none';
                nextStepBtn.style.display = selectedStores.length > 0 ? 'block' : 'none';
                prevStepBtn.style.display = 'none';
            }
        }
        
        // 更新门店选择面板
        function updateStoreSelectionPanel() {
            storeSelectionPanel.innerHTML = '';
            const searchTerm = storeSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            storeOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    storeSelectionPanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedStores.some(store => store.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="store_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="store_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedStores.push(option);
                        } else {
                            selectedStores = selectedStores.filter(store => store.id !== option.id);
                        }
                        updateSelectedCounts();
                    });
                    
                    storeSelectionPanel.appendChild(item);
                });
            });
        }
        
        // 更新产品选择面板
        function updateProductSelectionPanel() {
            productSelectionPanel.innerHTML = '';
            const searchTerm = productSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            productOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    productSelectionPanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedProducts.some(product => product.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="product_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="product_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedProducts.push(option);
                        } else {
                            selectedProducts = selectedProducts.filter(product => product.id !== option.id);
                        }
                        updateSelectedCounts();
                    });
                    
                    productSelectionPanel.appendChild(item);
                });
            });
        }
        
        // 更新门店*产品门店选择面板
        function updateStoreProductStorePanel() {
            storeProductStorePanel.innerHTML = '';
            const searchTerm = storeProductStoreSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            storeOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    storeProductStorePanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedStores.some(store => store.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="store_product_store_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="store_product_store_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedStores.push(option);
                        } else {
                            selectedStores = selectedStores.filter(store => store.id !== option.id);
                        }
                        updateSelectedCounts();
                        updateStoreProductInfo();
                        
                        // 显示/隐藏下一步按钮
                        nextStepBtn.style.display = selectedStores.length > 0 ? 'block' : 'none';
                    });
                    
                    storeProductStorePanel.appendChild(item);
                });
            });
        }
        
        // 更新门店*产品产品选择面板
        function updateStoreProductProductPanel() {
            storeProductProductPanel.innerHTML = '';
            const searchTerm = storeProductProductSearch.value.toLowerCase();
            
            // 按组分类
            const groupedOptions = {};
            productOptions.forEach(option => {
                const group = option.group || '其他';
                if (!groupedOptions[group]) {
                    groupedOptions[group] = [];
                }
                groupedOptions[group].push(option);
            });
            
            // 渲染分组
            Object.keys(groupedOptions).forEach(group => {
                // 组标题
                if (group !== '其他') {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'selection-item';
                    groupHeader.style.fontWeight = '600';
                    groupHeader.style.color = '#1890ff';
                    groupHeader.style.cursor = 'default';
                    groupHeader.textContent = `▼ ${group} (${groupedOptions[group].length})`;
                    storeProductProductPanel.appendChild(groupHeader);
                }
                
                // 组内选项
                groupedOptions[group].forEach(option => {
                    // 检查是否匹配搜索
                    if (searchTerm && !option.name.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const isSelected = selectedProducts.some(product => product.id === option.id);
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    item.innerHTML = `
                        <input type="checkbox" id="store_product_product_${option.id}" ${isSelected ? 'checked' : ''}>
                        <label for="store_product_product_${option.id}">${option.name}</label>
                    `;
                    
                    // 添加事件监听器
                    const checkbox = item.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedProducts.push(option);
                        } else {
                            selectedProducts = selectedProducts.filter(product => product.id !== option.id);
                        }
                        updateSelectedCounts();
                        updateStoreProductInfo();
                    });
                    
                    storeProductProductPanel.appendChild(item);
                });
            });
        }
        
        // 更新所有已选择数量
        function updateSelectedCounts() {
            selectedStoreCount.textContent = selectedStores.length;
            selectedProductCount.textContent = selectedProducts.length;
            selectedStoreProductStoreCount.textContent = selectedStores.length;
            selectedStoreProductProductCount.textContent = selectedProducts.length;
        }
        
        // 更新门店*产品信息
        function updateStoreProductInfo() {
            const storeCount = selectedStores.length;
            const productCount = selectedProducts.length;
            const combinationCount = storeCount * productCount;
            selectedStoreProductInfo.textContent = `${storeCount}个门店 × ${productCount}个产品 = ${combinationCount}种组合`;
        }

        // 重置表单
        function resetForm() {
            experimentForm.reset();
            selectedStores = [];
            selectedProducts = [];
            currentStep = 1;
            updateSelectedCounts();
            updateStoreProductInfo();
            
            // 设置默认维度为门店
            document.getElementById('dimensionStore').checked = true;
            currentDimension = 'store';
            currentCompareType = 'time';
            
            // 设置默认对比类型按钮
            compareTypeButtons.forEach(btn => {
                if (btn.getAttribute('data-compare-type') === 'time') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新选择区域
            updateSelectionSections();
            
            // 显示时间对比部分
            timeCompareSection.classList.add('active');
            dimensionCompareSection.classList.remove('active');
            
            // 设置默认日期
            const today = new Date();
            const experimentStartDate = document.getElementById('experimentStartDate');
            const experimentEndDate = document.getElementById('experimentEndDate');
            
            experimentStartDate.valueAsDate = today;
            
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 7);
            experimentEndDate.valueAsDate = endDate;
            
            // 维度对比的日期
            const dimensionExperimentStartDate = document.getElementById('dimensionExperimentStartDate');
            const dimensionExperimentEndDate = document.getElementById('dimensionExperimentEndDate');
            dimensionExperimentStartDate.valueAsDate = today;
            dimensionExperimentEndDate.valueAsDate = endDate;
            
            // 设置对比周期默认值为实验周期前7天
            const compareStartDate = document.getElementById('compareStartDate');
            const compareEndDate = document.getElementById('compareEndDate');
            
            const compareStart = new Date(today);
            compareStart.setDate(compareStart.getDate() - 7);
            const compareEnd = new Date(today);
            compareEnd.setDate(compareEnd.getDate() - 1);
            
            compareStartDate.valueAsDate = compareStart;
            compareEndDate.valueAsDate = compareEnd;
        }

        // 模拟从数据库获取数据
        function calculateExperimentData(experimentInfo) {
            // 模拟计算延迟
            return new Promise((resolve) => {
                setTimeout(() => {
                    let beforeData = { sales: 0, profit: 0, margin: 0 };
                    let afterData = { sales: 0, profit: 0, margin: 0 };
                    let objectDetails = [];
                    
                    if (experimentInfo.compareType === 'time') {
                        // 时间对比：计算实验前后数据
                        const experimentPeriod = experimentInfo.experimentPeriod.split(' 至 ');
                        const comparePeriod = experimentInfo.comparePeriod.split(' 至 ');
                        
                        if (experimentInfo.dimension === 'store') {
                            // 门店维度
                            selectedStores.forEach(store => {
                                const storeBeforeData = calculatePeriodDataForStore(
                                    store.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                const storeAfterData = calculatePeriodDataForStore(
                                    store.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                beforeData.sales += storeBeforeData.sales;
                                beforeData.profit += storeBeforeData.profit;
                                beforeData.margin = storeBeforeData.margin; // 利润率相同
                                
                                afterData.sales += storeAfterData.sales;
                                afterData.profit += storeAfterData.profit;
                                afterData.margin = storeAfterData.margin; // 利润率相同
                                
                                // 添加门店详情
                                objectDetails.push({
                                    name: store.name,
                                    beforeSales: storeBeforeData.sales,
                                    afterSales: storeAfterData.sales,
                                    salesChange: calculateChangeRate(storeBeforeData.sales, storeAfterData.sales),
                                    beforeProfit: storeBeforeData.profit,
                                    afterProfit: storeAfterData.profit,
                                    profitChange: calculateChangeRate(storeBeforeData.profit, storeAfterData.profit),
                                    beforeMargin: storeBeforeData.margin,
                                    afterMargin: storeAfterData.margin,
                                    marginChange: calculateChangeRate(storeBeforeData.margin, storeAfterData.margin)
                                });
                            });
                            
                            // 计算整体利润率
                            beforeData.margin = beforeData.sales > 0 ? (beforeData.profit / beforeData.sales) * 100 : 0;
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                            
                        } else if (experimentInfo.dimension === 'product') {
                            // 产品维度
                            selectedProducts.forEach(product => {
                                const productBeforeData = calculatePeriodDataForProduct(
                                    product.id,
                                    comparePeriod[0], 
                                    comparePeriod[1]
                                );
                                
                                const productAfterData = calculatePeriodDataForProduct(
                                    product.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                beforeData.sales += productBeforeData.sales;
                                beforeData.profit += productBeforeData.profit;
                                
                                afterData.sales += productAfterData.sales;
                                afterData.profit += productAfterData.profit;
                                
                                // 添加产品详情
                                objectDetails.push({
                                    name: product.name,
                                    beforeSales: productBeforeData.sales,
                                    afterSales: productAfterData.sales,
                                    salesChange: calculateChangeRate(productBeforeData.sales, productAfterData.sales),
                                    beforeProfit: productBeforeData.profit,
                                    afterProfit: productAfterData.profit,
                                    profitChange: calculateChangeRate(productBeforeData.profit, productAfterData.profit),
                                    beforeMargin: productBeforeData.margin,
                                    afterMargin: productAfterData.margin,
                                    marginChange: calculateChangeRate(productBeforeData.margin, productAfterData.margin)
                                });
                            });
                            
                            // 计算整体利润率
                            beforeData.margin = beforeData.sales > 0 ? (beforeData.profit / beforeData.sales) * 100 : 0;
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                            
                        } else if (experimentInfo.dimension === 'store_product') {
                            // 门店*产品维度
                            selectedStores.forEach(store => {
                                selectedProducts.forEach(product => {
                                    // 模拟门店*产品组合数据
                                    const storeMultiplier = historicalSalesData.stores[store.id] ? 0.7 : 0.5;
                                    const productMultiplier = historicalSalesData.products[product.id] ? 0.3 : 0.5;
                                    
                                    const days = Math.floor(
                                        (new Date(experimentPeriod[1]) - new Date(experimentPeriod[0])) / (1000 * 60 * 60 * 24)
                                    ) + 1;
                                    
                                    // 生成模拟数据
                                    const dailySales = Math.floor((10000 * storeMultiplier * productMultiplier) / days);
                                    const dailyProfit = Math.floor(dailySales * 0.3);
                                    
                                    const beforeDailySales = Math.floor((9000 * storeMultiplier * productMultiplier) / days);
                                    const beforeDailyProfit = Math.floor(beforeDailySales * 0.3);
                                    
                                    const storeProductBeforeData = {
                                        sales: beforeDailySales * days,
                                        profit: beforeDailyProfit * days,
                                        margin: 30.0
                                    };
                                    
                                    const storeProductAfterData = {
                                        sales: dailySales * days,
                                        profit: dailyProfit * days,
                                        margin: 30.0
                                    };
                                    
                                    beforeData.sales += storeProductBeforeData.sales;
                                    beforeData.profit += storeProductBeforeData.profit;
                                    
                                    afterData.sales += storeProductAfterData.sales;
                                    afterData.profit += storeProductAfterData.profit;
                                    
                                    // 添加门店*产品详情
                                    objectDetails.push({
                                        name: `${store.name}-${product.name}`,
                                        beforeSales: storeProductBeforeData.sales,
                                        afterSales: storeProductAfterData.sales,
                                        salesChange: calculateChangeRate(storeProductBeforeData.sales, storeProductAfterData.sales),
                                        beforeProfit: storeProductBeforeData.profit,
                                        afterProfit: storeProductAfterData.profit,
                                        profitChange: calculateChangeRate(storeProductBeforeData.profit, storeProductAfterData.profit),
                                        beforeMargin: storeProductBeforeData.margin,
                                        afterMargin: storeProductAfterData.margin,
                                        marginChange: calculateChangeRate(storeProductBeforeData.margin, storeProductAfterData.margin)
                                    });
                                });
                            });
                            
                            // 计算整体利润率
                            beforeData.margin = beforeData.sales > 0 ? (beforeData.profit / beforeData.sales) * 100 : 0;
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                        }
                        
                    } else {
                        // 维度对比：计算实验组和对照组数据
                        const experimentPeriod = experimentInfo.experimentPeriod.split(' 至 ');
                        
                        // 模拟计算实验组数据
                        if (experimentInfo.dimension === 'store') {
                            // 门店维度
                            selectedStores.forEach(store => {
                                const storeData = calculatePeriodDataForStore(
                                    store.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                afterData.sales += storeData.sales;
                                afterData.profit += storeData.profit;
                                afterData.margin = storeData.margin; // 利润率相同
                                
                                // 添加门店详情
                                objectDetails.push({
                                    name: store.name,
                                    afterSales: storeData.sales,
                                    afterProfit: storeData.profit,
                                    afterMargin: storeData.margin,
                                    // 维度对比没有before数据，这里用0表示
                                    beforeSales: 0,
                                    beforeProfit: 0,
                                    beforeMargin: 0,
                                    salesChange: 0,
                                    profitChange: 0,
                                    marginChange: 0
                                });
                            });
                            
                            // 计算整体利润率
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                            
                            // 模拟计算对照组数据（其他门店）
                            beforeData.sales = Math.round(afterData.sales * 0.8); // 对照组是实验组的80%
                            beforeData.profit = Math.round(beforeData.sales * 0.3); // 30%利润率
                            beforeData.margin = 30.0;
                            
                        } else if (experimentInfo.dimension === 'product') {
                            // 产品维度
                            selectedProducts.forEach(product => {
                                const productData = calculatePeriodDataForProduct(
                                    product.id,
                                    experimentPeriod[0], 
                                    experimentPeriod[1]
                                );
                                
                                afterData.sales += productData.sales;
                                afterData.profit += productData.profit;
                                
                                // 添加产品详情
                                objectDetails.push({
                                    name: product.name,
                                    afterSales: productData.sales,
                                    afterProfit: productData.profit,
                                    afterMargin: productData.margin,
                                    // 维度对比没有before数据，这里用0表示
                                    beforeSales: 0,
                                    beforeProfit: 0,
                                    beforeMargin: 0,
                                    salesChange: 0,
                                    profitChange: 0,
                                    marginChange: 0
                                });
                            });
                            
                            // 计算整体利润率
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                            
                            // 检查实验产品是否同一品类
                            const firstGroup = selectedProducts.length > 0 ? selectedProducts[0].group : null;
                            const isSameCategory = selectedProducts.every(product => product.group === firstGroup);
                            
                            // 模拟计算对照组数据
                            if (isSameCategory && firstGroup) {
                                // 同一品类：对照同品类其他产品
                                beforeData.sales = Math.round(afterData.sales * 0.75); // 对照组是实验组的75%
                            } else {
                                // 不同品类：对照所有其他产品
                                beforeData.sales = Math.round(afterData.sales * 0.7); // 对照组是实验组的70%
                            }
                            beforeData.profit = Math.round(beforeData.sales * 0.3); // 30%利润率
                            beforeData.margin = 30.0;
                            
                        } else if (experimentInfo.dimension === 'store_product') {
                            // 门店*产品维度
                            selectedStores.forEach(store => {
                                selectedProducts.forEach(product => {
                                    // 模拟门店*产品组合数据
                                    const storeMultiplier = historicalSalesData.stores[store.id] ? 0.7 : 0.5;
                                    const productMultiplier = historicalSalesData.products[product.id] ? 0.3 : 0.5;
                                    
                                    const days = Math.floor(
                                        (new Date(experimentPeriod[1]) - new Date(experimentPeriod[0])) / (1000 * 60 * 60 * 24)
                                    ) + 1;
                                    
                                    // 生成模拟数据
                                    const dailySales = Math.floor((10000 * storeMultiplier * productMultiplier) / days);
                                    const dailyProfit = Math.floor(dailySales * 0.3);
                                    
                                    const storeProductData = {
                                        sales: dailySales * days,
                                        profit: dailyProfit * days,
                                        margin: 30.0
                                    };
                                    
                                    afterData.sales += storeProductData.sales;
                                    afterData.profit += storeProductData.profit;
                                    
                                    // 添加门店*产品详情
                                    objectDetails.push({
                                        name: `${store.name}-${product.name}`,
                                        afterSales: storeProductData.sales,
                                        afterProfit: storeProductData.profit,
                                        afterMargin: storeProductData.margin,
                                        // 维度对比没有before数据，这里用0表示
                                        beforeSales: 0,
                                        beforeProfit: 0,
                                        beforeMargin: 0,
                                        salesChange: 0,
                                        profitChange: 0,
                                        marginChange: 0
                                    });
                                });
                            });
                            
                            // 计算整体利润率
                            afterData.margin = afterData.sales > 0 ? (afterData.profit / afterData.sales) * 100 : 0;
                            
                            // 检查实验产品是否同一品类
                            const firstGroup = selectedProducts.length > 0 ? selectedProducts[0].group : null;
                            const isSameCategory = selectedProducts.every(product => product.group === firstGroup);
                            
                            // 模拟计算对照组数据
                            if (isSameCategory && firstGroup) {
                                // 同一品类：对照同品类其他产品
                                beforeData.sales = Math.round(afterData.sales * 0.75); // 对照组是实验组的75%
                            } else {
                                // 不同品类：对照所有其他产品
                                beforeData.sales = Math.round(afterData.sales * 0.7); // 对照组是实验组的70%
                            }
                            beforeData.profit = Math.round(beforeData.sales * 0.3); // 30%利润率
                            beforeData.margin = 30.0;
                        }
                    }
                    
                    resolve({ beforeData, afterData, objectDetails });
                }, 1500); // 模拟1.5秒计算时间
            });
        }
        
        // 计算指定时间段内的门店数据
        function calculatePeriodDataForStore(storeId, startDate, endDate) {
            let totalSales = 0;
            let totalProfit = 0;
            
            if (historicalSalesData.stores[storeId]) {
                const storeData = historicalSalesData.stores[storeId];
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // 计算时间段内的数据
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    const dateStr = formatDateForData(date);
                    if (storeData[dateStr]) {
                        totalSales += storeData[dateStr].sales;
                        totalProfit += storeData[dateStr].profit;
                    }
                }
            }
            
            // 如果没有数据，生成随机数据
            if (totalSales === 0) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                totalSales = days * 15000;
                totalProfit = Math.floor(totalSales * 0.3);
            }
            
            const margin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            return {
                sales: totalSales,
                profit: totalProfit,
                margin: Math.round(margin * 10) / 10
            };
        }
        
        // 计算指定时间段内的产品数据
        function calculatePeriodDataForProduct(productId, startDate, endDate) {
            let totalSales = 0;
            let totalProfit = 0;
            
            if (historicalSalesData.products[productId]) {
                const productData = historicalSalesData.products[productId];
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // 计算时间段内的数据
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    const dateStr = formatDateForData(date);
                    if (productData[dateStr]) {
                        totalSales += productData[dateStr].sales;
                        totalProfit += productData[dateStr].profit;
                    }
                }
            }
            
            // 如果没有数据，生成随机数据
            if (totalSales === 0) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                totalSales = days * 2000;
                totalProfit = Math.floor(totalSales * 0.3);
            }
            
            const margin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
            
            return {
                sales: totalSales,
                profit: totalProfit,
                margin: Math.round(margin * 10) / 10
            };
        }
        
        // 格式化日期用于数据查询
        function formatDateForData(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 保存实验
        async function saveExperiment() {
            // 获取表单数据
            const title = document.getElementById('experimentTitle').value;
            const dimension = document.querySelector('input[name="dimension"]:checked').value;
            
            // 验证数据
            if (!title.trim()) {
                alert('请输入实验标题');
                return;
            }
            
            // 验证选择对象
            if (dimension === 'store' && selectedStores.length === 0) {
                alert('请选择门店');
                return;
            }
            
            if (dimension === 'product' && selectedProducts.length === 0) {
                alert('请选择产品');
                return;
            }
            
            if (dimension === 'store_product' && (selectedStores.length === 0 || selectedProducts.length === 0)) {
                alert('请选择门店和产品');
                return;
            }
            
            // 显示加载动画
            formLoading.classList.add('active');
            
            let experimentInfo;
            let compareObject = '';
            
            if (currentCompareType === 'time') {
                // 时间对比
                const experimentStartDate = document.getElementById('experimentStartDate').value;
                const experimentEndDate = document.getElementById('experimentEndDate').value;
                const compareStartDate = document.getElementById('compareStartDate').value;
                const compareEndDate = document.getElementById('compareEndDate').value;
                
                if (!experimentStartDate || !experimentEndDate || !compareStartDate || !compareEndDate) {
                    alert('请填写完整的实验周期和对比周期');
                    formLoading.classList.remove('active');
                    return;
                }
                
                experimentInfo = {
                    dimension: dimension,
                    selectedStores: selectedStores,
                    selectedProducts: selectedProducts,
                    compareType: 'time',
                    experimentPeriod: `${formatDate(experimentStartDate)} 至 ${formatDate(experimentEndDate)}`,
                    comparePeriod: `${formatDate(compareStartDate)} 至 ${formatDate(compareEndDate)}`
                };
            } else {
                // 维度对比
                const experimentStartDate = document.getElementById('dimensionExperimentStartDate').value;
                const experimentEndDate = document.getElementById('dimensionExperimentEndDate').value;
                
                if (!experimentStartDate || !experimentEndDate) {
                    alert('请填写完整的实验周期');
                    formLoading.classList.remove('active');
                    return;
                }
                
                // 自动生成对比对象描述
                if (dimension === 'store') {
                    compareObject = '除实验门店外的全部同公司门店';
                } else if (dimension === 'product') {
                    // 检查实验产品是否同一品类
                    const firstGroup = selectedProducts.length > 0 ? selectedProducts[0].group : null;
                    const isSameCategory = selectedProducts.every(product => product.group === firstGroup);
                    
                    if (isSameCategory && firstGroup) {
                        compareObject = `除实验产品外同品类(${firstGroup})的产品`;
                    } else {
                        compareObject = '除实验产品外所有产品';
                    }
                } else {
                    // 门店*产品
                    const firstGroup = selectedProducts.length > 0 ? selectedProducts[0].group : null;
                    const isSameCategory = selectedProducts.every(product => product.group === firstGroup);
                    
                    if (isSameCategory && firstGroup) {
                        compareObject = `除实验产品外同品类(${firstGroup})的产品`;
                    } else {
                        compareObject = '除实验产品外所有产品';
                    }
                }
                
                experimentInfo = {
                    dimension: dimension,
                    selectedStores: selectedStores,
                    selectedProducts: selectedProducts,
                    compareType: 'dimension',
                    experimentPeriod: `${formatDate(experimentStartDate)} 至 ${formatDate(experimentEndDate)}`,
                    compareObject: compareObject
                };
            }
            
            try {
                // 模拟计算实验数据
                const { beforeData, afterData, objectDetails } = await calculateExperimentData(experimentInfo);
                
                // 创建实验对象
                const experiment = {
                    id: editingExperimentId || experimentData.length + 1,
                    title: title,
                    dimension: dimension,
                    objectType: dimension === 'store' ? '门店' : 
                               dimension === 'product' ? '产品' : '门店*产品',
                    objectCount: dimension === 'store_product' ? selectedStores.length * selectedProducts.length : 
                                dimension === 'store' ? selectedStores.length : selectedProducts.length,
                    storeCount: selectedStores.length,
                    productCount: selectedProducts.length,
                    storeNames: selectedStores.map(store => store.name),
                    productNames: selectedProducts.map(product => product.name),
                    compareType: currentCompareType,
                    ...experimentInfo,
                    beforeData: beforeData,
                    afterData: afterData,
                    objectDetails: objectDetails
                };
                
                // 添加或更新实验数据
                if (editingExperimentId) {
                    // 更新现有实验
                    const index = experimentData.findIndex(exp => exp.id === editingExperimentId);
                    if (index !== -1) {
                        experimentData[index] = experiment;
                    }
                } else {
                    // 添加新实验
                    experimentData.push(experiment);
                }
                
                // 更新表格
                renderExperimentTable();
                
                // 关闭弹窗
                experimentFormModal.classList.remove('active');
                formLoading.classList.remove('active');
                
                // 显示成功消息
                alert(`实验"${title}"已成功${editingExperimentId ? '更新' : '添加'}！`);
            } catch (error) {
                console.error('计算实验数据时出错:', error);
                alert('计算实验数据时出错，请稍后重试');
                formLoading.classList.remove('active');
            }
        }

        // 编辑实验
        function editExperiment(experimentId) {
            const experiment = experimentData.find(exp => exp.id === experimentId);
            if (!experiment) return;
            
            editingExperimentId = experimentId;
            formModalTitle.textContent = '编辑实验记录';
            
            // 填充表单数据
            document.getElementById('experimentTitle').value = experiment.title;
            
            // 设置维度
            if (experiment.dimension === 'store') {
                document.getElementById('dimensionStore').checked = true;
                currentDimension = 'store';
            } else if (experiment.dimension === 'product') {
                document.getElementById('dimensionProduct').checked = true;
                currentDimension = 'product';
            } else {
                document.getElementById('dimensionStoreProduct').checked = true;
                currentDimension = 'store_product';
            }
            
            // 设置对比类型
            currentCompareType = experiment.compareType;
            switchCompareType(experiment.compareType);
            
            // 设置实验对象
            selectedStores = experiment.storeNames.map(name => {
                return storeOptions.find(opt => opt.name === name) || { id: Date.now(), name: name };
            });
            
            selectedProducts = experiment.productNames.map(name => {
                return productOptions.find(opt => opt.name === name) || { id: Date.now(), name: name };
            });
            
            if (experiment.compareType === 'time') {
                // 设置日期
                const experimentPeriodParts = experiment.experimentPeriod.split(' 至 ');
                document.getElementById('experimentStartDate').value = parseDateString(experimentPeriodParts[0]);
                document.getElementById('experimentEndDate').value = parseDateString(experimentPeriodParts[1]);
                
                const comparePeriodParts = experiment.comparePeriod.split(' 至 ');
                document.getElementById('compareStartDate').value = parseDateString(comparePeriodParts[0]);
                document.getElementById('compareEndDate').value = parseDateString(comparePeriodParts[1]);
            } else {
                // 维度对比
                const experimentPeriodParts = experiment.experimentPeriod.split(' 至 ');
                document.getElementById('dimensionExperimentStartDate').value = parseDateString(experimentPeriodParts[0]);
                document.getElementById('dimensionExperimentEndDate').value = parseDateString(experimentPeriodParts[1]);
            }
            
            // 更新UI
            updateSelectionSections();
            updateSelectedCounts();
            updateStoreProductInfo();
            
            // 显示表单弹窗
            experimentFormModal.classList.add('active');
        }

        // 删除实验
        function deleteExperiment(experimentId) {
            if (!confirm('确定要删除这个实验记录吗？此操作不可撤销。')) {
                return;
            }
            
            const index = experimentData.findIndex(exp => exp.id === experimentId);
            if (index !== -1) {
                experimentData.splice(index, 1);
                renderExperimentTable();
                alert('实验记录已删除');
            }
        }

        // 显示实验对象详情弹窗
        function showObjectDetailModal(experimentId) {
            const experiment = experimentData.find(exp => exp.id === experimentId);
            if (!experiment) return;
            
            detailModalTitle.textContent = `${experiment.title} - 实验对象详情`;
            
            let detailsHTML = '';
            
            if (experiment.dimension === 'store') {
                detailsHTML = `
                    <div class="detail-item">
                        <div class="detail-label">实验门店详情 (共${experiment.objectCount}个门店)</div>
                        <table class="object-detail-table">
                            <thead>
                                <tr>
                                    <th>门店名称</th>
                                    <th>销额对比</th>
                                    <th>毛利额对比</th>
                                    <th>利润率对比</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                experiment.objectDetails.forEach(detail => {
                    const salesChangeClass = detail.salesChange >= 0 ? 'positive' : 'negative';
                    const profitChangeClass = detail.profitChange >= 0 ? 'positive' : 'negative';
                    const marginChangeClass = detail.marginChange >= 0 ? 'positive' : 'negative';
                    
                    const salesChangeSign = detail.salesChange >= 0 ? '+' : '';
                    const profitChangeSign = detail.profitChange >= 0 ? '+' : '';
                    const marginChangeSign = detail.marginChange >= 0 ? '+' : '';
                    
                    detailsHTML += `
                        <tr>
                            <td>${detail.name}</td>
                            <td class="${salesChangeClass}">
                                ¥${detail.beforeSales.toLocaleString()} → ¥${detail.afterSales.toLocaleString()}
                                <br><small>${salesChangeSign}${detail.salesChange}%</small>
                            </td>
                            <td class="${profitChangeClass}">
                                ¥${detail.beforeProfit.toLocaleString()} → ¥${detail.afterProfit.toLocaleString()}
                                <br><small>${profitChangeSign}${detail.profitChange}%</small>
                            </td>
                            <td class="${marginChangeClass}">
                                ${detail.beforeMargin}% → ${detail.afterMargin}%
                                <br><small>${marginChangeSign}${detail.marginChange}%</small>
                            </td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
            } else if (experiment.dimension === 'product') {
                detailsHTML = `
                    <div class="detail-item">
                        <div class="detail-label">实验产品详情 (共${experiment.objectCount}个产品)</div>
                        <table class="object-detail-table">
                            <thead>
                                <tr>
                                    <th>产品名称</th>
                                    <th>销额对比</th>
                                    <th>毛利额对比</th>
                                    <th>利润率对比</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                experiment.objectDetails.forEach(detail => {
                    const salesChangeClass = detail.salesChange >= 0 ? 'positive' : 'negative';
                    const profitChangeClass = detail.profitChange >= 0 ? 'positive' : 'negative';
                    const marginChangeClass = detail.marginChange >= 0 ? 'positive' : 'negative';
                    
                    const salesChangeSign = detail.salesChange >= 0 ? '+' : '';
                    const profitChangeSign = detail.profitChange >= 0 ? '+' : '';
                    const marginChangeSign = detail.marginChange >= 0 ? '+' : '';
                    
                    detailsHTML += `
                        <tr>
                            <td>${detail.name}</td>
                            <td class="${salesChangeClass}">
                                ¥${detail.beforeSales.toLocaleString()} → ¥${detail.afterSales.toLocaleString()}
                                <br><small>${salesChangeSign}${detail.salesChange}%</small>
                            </td>
                            <td class="${profitChangeClass}">
                                ¥${detail.beforeProfit.toLocaleString()} → ¥${detail.afterProfit.toLocaleString()}
                                <br><small>${profitChangeSign}${detail.profitChange}%</small>
                            </td>
                            <td class="${marginChangeClass}">
                                ${detail.beforeMargin}% → ${detail.afterMargin}%
                                <br><small>${marginChangeSign}${detail.marginChange}%</small>
                            </td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
            } else if (experiment.dimension === 'store_product') {
                detailsHTML = `
                    <div class="detail-item">
                        <div class="detail-label">门店*产品组合详情 (共${experiment.storeCount}个门店 × ${experiment.productCount}个产品)</div>
                        <table class="object-detail-table">
                            <thead>
                                <tr>
                                    <th>门店-产品组合</th>
                                    <th>销额对比</th>
                                    <th>毛利额对比</th>
                                    <th>利润率对比</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                experiment.objectDetails.forEach(detail => {
                    const salesChangeClass = detail.salesChange >= 0 ? 'positive' : 'negative';
                    const profitChangeClass = detail.profitChange >= 0 ? 'positive' : 'negative';
                    const marginChangeClass = detail.marginChange >= 0 ? 'positive' : 'negative';
                    
                    const salesChangeSign = detail.salesChange >= 0 ? '+' : '';
                    const profitChangeSign = detail.profitChange >= 0 ? '+' : '';
                    const marginChangeSign = detail.marginChange >= 0 ? '+' : '';
                    
                    detailsHTML += `
                        <tr>
                            <td>${detail.name}</td>
                            <td class="${salesChangeClass}">
                                ¥${detail.beforeSales.toLocaleString()} → ¥${detail.afterSales.toLocaleString()}
                                <br><small>${salesChangeSign}${detail.salesChange}%</small>
                            </td>
                            <td class="${profitChangeClass}">
                                ¥${detail.beforeProfit.toLocaleString()} → ¥${detail.afterProfit.toLocaleString()}
                                <br><small>${profitChangeSign}${detail.profitChange}%</small>
                            </td>
                            <td class="${marginChangeClass}">
                                ${detail.beforeMargin}% → ${detail.afterMargin}%
                                <br><small>${marginChangeSign}${detail.marginChange}%</small>
                            </td>
                        </tr>
                    `;
                });
                
                detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            detailModalBody.innerHTML = detailsHTML;
            detailModal.classList.add('active');
        }

        // 显示实验详情弹窗
        function showExperimentDetailModal(experimentId) {
            const experiment = experimentData.find(exp => exp.id === experimentId);
            if (!experiment) return;
            
            // 计算变化率
            const salesChangeRate = calculateChangeRate(experiment.beforeData.sales, experiment.afterData.sales);
            const profitChangeRate = calculateChangeRate(experiment.beforeData.profit, experiment.afterData.profit);
            const marginChangeRate = calculateChangeRate(experiment.beforeData.margin, experiment.afterData.margin);
            
            // 变化率符号
            const salesChangeSign = salesChangeRate >= 0 ? '+' : '';
            const profitChangeSign = profitChangeRate >= 0 ? '+' : '';
            const marginChangeSign = marginChangeRate >= 0 ? '+' : '';
            
            detailModalTitle.textContent = experiment.title;
            
            let compareInfo = '';
            if (experiment.compareType === 'time') {
                compareInfo = `
                    <div class="detail-item">
                        <div class="detail-label">对比周期</div>
                        <div class="detail-value">${experiment.comparePeriod}</div>
                    </div>
                `;
            } else {
                compareInfo = `
                    <div class="detail-item">
                        <div class="detail-label">对比对象</div>
                        <div class="detail-value">${experiment.compareObject}</div>
                    </div>
                `;
            }
            
            let beforeLabel = experiment.compareType === 'time' ? '实验前数据' : '对照组数据';
            let afterLabel = experiment.compareType === 'time' ? '实验后数据' : '实验组数据';
            
            detailModalBody.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">实验标题</div>
                    <div class="detail-value">${experiment.title}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">类型</div>
                    <div class="detail-value">${experiment.dimension === 'store' ? '门店' : 
                                             experiment.dimension === 'product' ? '产品' : '门店*产品'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">对比类型</div>
                    <div class="detail-value">${experiment.compareType === 'time' ? '时间对比' : '维度对比'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">实验对象</div>
                    <div class="detail-value">${experiment.objectType} (${experiment.dimension === 'store_product' ? 
                        `${experiment.storeCount}个门店 × ${experiment.productCount}个产品` : `${experiment.objectCount}个`})</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">实验周期</div>
                    <div class="detail-value">${experiment.experimentPeriod}</div>
                </div>
                ${compareInfo}
                <div class="detail-item">
                    <div class="detail-label">${beforeLabel}</div>
                    <div class="detail-value">
                        销额: ¥${experiment.beforeData.sales.toLocaleString()}<br>
                        毛利: ¥${experiment.beforeData.profit.toLocaleString()}<br>
                        利润率: ${experiment.beforeData.margin}%
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">${afterLabel}</div>
                    <div class="detail-value">
                        销额: ¥${experiment.afterData.sales.toLocaleString()}<br>
                        毛利: ¥${experiment.afterData.profit.toLocaleString()}<br>
                        利润率: ${experiment.afterData.margin}%
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">销额对比</div>
                    <div class="detail-value">
                        ¥${experiment.beforeData.sales.toLocaleString()} → ¥${experiment.afterData.sales.toLocaleString()}
                        <br>
                        <span class="${salesChangeRate >= 0 ? 'positive' : 'negative'}">变化率: ${salesChangeSign}${salesChangeRate}%</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">毛利额对比</div>
                    <div class="detail-value">
                        ¥${experiment.beforeData.profit.toLocaleString()} → ¥${experiment.afterData.profit.toLocaleString()}
                        <br>
                        <span class="${profitChangeRate >= 0 ? 'positive' : 'negative'}">变化率: ${profitChangeSign}${profitChangeRate}%</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">利润率对比</div>
                    <div class="detail-value">
                        ${experiment.beforeData.margin}% → ${experiment.afterData.margin}%
                        <br>
                        <span class="${marginChangeRate >= 0 ? 'positive' : 'negative'}">变化率: ${marginChangeSign}${marginChangeRate}%</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">数据来源</div>
                    <div class="detail-value">
                        <i class="fas fa-database"></i> 系统自动计算，基于销售数据库历史数据
                    </div>
                </div>
            `;
            
            detailModal.classList.add('active');
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // 辅助函数：解析日期字符串
        function parseDateString(dateString) {
            // 假设日期格式为 YYYY-MM-DD
            return dateString;
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
