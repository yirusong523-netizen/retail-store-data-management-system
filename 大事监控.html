<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>门店大事管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: #f5f7f9;
            color: #333;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .header-left h1 {
            color: #1890ff;
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .btn-add {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-add:hover {
            background: #40a9ff;
            transform: translateY(-2px);
        }
        
        /* 大事列表区域 */
        .list-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-btn {
            padding: 6px 16px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        
        .btn-close:hover {
            color: #666;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-label .required {
            color: #ff4d4f;
            margin-left: 2px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }
        
        .custom-type-container {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .custom-type-container.hidden {
            display: none;
        }
        
        .custom-type-input {
            flex: 1;
        }
        
        .btn-add-custom {
            background: #52c41a;
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .btn-add-custom:hover {
            background: #73d13d;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e8e8e8;
        }
        
        /* 大事卡片 */
        .events-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .event-card {
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            padding: 16px;
            transition: all 0.3s;
        }
        
        .event-card:hover {
            border-color: #1890ff;
            box-shadow: 0 2px 8px rgba(24,144,255,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .event-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .event-tags {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .tag {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .tag-store {
            background: #f0f5ff;
            color: #2f54eb;
        }
        
        .tag-type-personnel {
            background: #fff2e8;
            color: #fa541c;
        }
        
        .tag-type-certification {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .tag-type-equipment {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .tag-type-custom {
            background: #f9f0ff;
            color: #722ed1;
        }
        
        .tag-urgent {
            background: #fff1f0;
            color: #cf1322;
        }
        
        .event-meta {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 13px;
            color: #666;
            flex-wrap: wrap;
        }
        
        .event-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-meta-item i {
            font-style: normal;
        }
        
        /* 状态选项 */
        .status-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .status-option {
            flex: 1;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .status-option:hover {
            border-color: #1890ff;
        }
        
        .status-option.active {
            color: white;
        }
        
        .status-option[data-status="未处理"] {
            background: #fff2f0;
            border-color: #ffccc7;
        }
        
        .status-option[data-status="未处理"].active {
            background: #ff4d4f;
            border-color: #ff4d4f;
        }
        
        .status-option[data-status="处理中"] {
            background: #fff7e6;
            border-color: #ffd591;
        }
        
        .status-option[data-status="处理中"].active {
            background: #fa8c16;
            border-color: #fa8c16;
        }
        
        .status-option[data-status="已处理"] {
            background: #f6ffed;
            border-color: #b7eb8f;
        }
        
        .status-option[data-status="已处理"].active {
            background: #52c41a;
            border-color: #52c41a;
        }
        
        /* 已处理大事表格 */
        .completed-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e8e8e8;
        }
        
        .completed-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .completed-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .completed-table th {
            background: #fafafa;
            color: #666;
            font-weight: 500;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .completed-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        
        .completed-table tr:last-child td {
            border-bottom: none;
        }
        
        .completed-table tr:hover {
            background: #fafafa;
        }
        
        .table-tag {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #d9d9d9;
        }
        
        /* 自定义类型管理 */
        .custom-types {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .custom-types-title {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-manage-types {
            background: none;
            border: 1px solid #d9d9d9;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }
        
        .btn-manage-types:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .custom-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .custom-tag {
            padding: 4px 12px;
            background: #f9f0ff;
            color: #722ed1;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .custom-tag button {
            background: none;
            border: none;
            color: #722ed1;
            cursor: pointer;
            font-size: 10px;
            padding: 2px;
        }
        
        /* 编辑状态按钮 */
        .btn-edit-status {
            background: #1890ff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-edit-status:hover {
            background: #40a9ff;
        }
        
        /* 编辑状态弹窗 */
        .status-modal .modal-body {
            text-align: center;
            padding: 30px 24px;
        }
        
        .current-status {
            font-size: 16px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .current-status strong {
            color: #52c41a;
            font-weight: 500;
        }
        
        .status-confirm-text {
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .status-options-modal {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .status-option-modal {
            padding: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .status-option-modal:hover {
            border-color: #1890ff;
            background-color: #f0f9ff;
        }
        
        .status-option-modal.active {
            border-color: #1890ff;
            background-color: #e6f7ff;
            color: #1890ff;
            font-weight: 500;
        }
        
        .modal-warning {
            background: #fff7e6;
            border: 1px solid #ffd591;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #fa8c16;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-warning i {
            font-style: normal;
            font-size: 16px;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* 响应式 */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .filters {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            
            .event-meta {
                gap: 10px;
            }
            
            .completed-table {
                display: block;
                overflow-x: auto;
            }
            
            .custom-type-container {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>门店大事管理</h1>
                <p class="subtitle">记录和跟踪各门店重要事项进度</p>
            </div>
            <button class="btn-add" id="openModalBtn">
                <i class="fas fa-plus"></i>
                添加大事
            </button>
        </header>
        
        <!-- 大事列表 -->
        <section class="list-section">
            <div class="section-header">
                <h2>进行中的大事</h2>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">全部</button>
                    <button class="filter-btn" data-filter="personnel">人员</button>
                    <button class="filter-btn" data-filter="certification">资质</button>
                    <button class="filter-btn" data-filter="equipment">设备</button>
                    <button class="filter-btn" data-filter="custom">自定义</button>
                    <button class="filter-btn" data-filter="urgent">紧急</button>
                </div>
            </div>
            
            <div class="events-container" id="activeEvents">
                <!-- 进行中的大事卡片将通过JavaScript动态生成 -->
            </div>
            
            <!-- 已处理大事表格 -->
            <div class="completed-section">
                <h3 class="completed-title">
                    <i class="fas fa-check-circle" style="color: #52c41a;"></i>
                    已处理完成的大事
                </h3>
                <div id="completedEvents">
                    <table class="completed-table">
                        <thead>
                            <tr>
                                <th width="30%">大事标题</th>
                                <th width="15%">门店</th>
                                <th width="15%">负责人</th>
                                <th width="20%">完成时间</th>
                                <th width="20%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="completedTableBody">
                            <!-- 已处理大事表格行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    
    <!-- 添加大事弹窗 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">添加新大事</h3>
                <button class="btn-close" id="closeModalBtn">&times;</button>
            </div>
            
            <form id="eventForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">
                            大事标题 <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="eventTitle" placeholder="例如：现烤师傅招聘" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            门店名称 <span class="required">*</span>
                        </label>
                        <select class="form-select" id="storeName" required>
                            <option value="">请选择门店</option>
                            <option value="公司总部">公司总部</option>
                            <option value="朝阳门店">朝阳门店</option>
                            <option value="海淀门店">海淀门店</option>
                            <option value="东城门店">东城门店</option>
                            <option value="西城门店">西城门店</option>
                            <option value="通州门店">通州门店</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            大事类型 <span class="required">*</span>
                        </label>
                        <select class="form-select" id="eventType" required>
                            <option value="personnel">人员</option>
                            <option value="certification">资质</option>
                            <option value="equipment">设备</option>
                            <option value="custom">自定义类型</option>
                        </select>
                        <div class="custom-type-container hidden" id="customTypeContainer">
                            <div class="custom-type-input">
                                <input type="text" class="form-input" id="customTypeInput" placeholder="输入自定义类型名称">
                            </div>
                            <button type="button" class="btn-add-custom" id="addCustomTypeBtn">添加</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            负责人 <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="assignee" placeholder="请输入负责人姓名" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            截止日期 <span class="required">*</span>
                        </label>
                        <input type="date" class="form-input" id="dueDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注说明</label>
                        <textarea class="form-input" id="description" rows="3" placeholder="补充说明或详细要求..."></textarea>
                    </div>
                    
                    <!-- 自定义类型展示区域 -->
                    <div class="custom-types">
                        <div class="custom-types-title">
                            <span>已添加的自定义类型</span>
                            <button type="button" class="btn-manage-types" id="manageTypesBtn">管理</button>
                        </div>
                        <div class="custom-tags" id="customTags">
                            <!-- 自定义类型标签将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
                    <button type="submit" class="btn btn-primary">确认添加</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 管理自定义类型弹窗 -->
    <div class="modal-overlay" id="manageTypesOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">管理自定义类型</h3>
                <button class="btn-close" id="closeManageTypesBtn">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">添加新类型</label>
                    <div class="custom-type-container">
                        <div class="custom-type-input">
                            <input type="text" class="form-input" id="newCustomType" placeholder="输入自定义类型名称">
                        </div>
                        <button type="button" class="btn-add-custom" id="addNewCustomTypeBtn">添加</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">已添加的类型</label>
                    <div id="manageCustomTags" style="min-height: 200px;">
                        <!-- 管理页面的自定义类型标签将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeManageModalBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑状态弹窗 -->
    <div class="modal-overlay" id="editStatusModal">
        <div class="modal status-modal">
            <div class="modal-header">
                <h3 class="modal-title">编辑大事状态</h3>
                <button class="btn-close" id="closeEditStatusBtn">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="current-status">
                    当前状态：<strong id="currentStatusText">已处理</strong>
                </div>
                
                <div class="modal-warning">
                    <i>⚠️</i>
                    已处理的大事重新编辑状态可能会影响统计，请谨慎操作！
                </div>
                
                <div class="status-confirm-text">
                    请选择要修改为的新状态：
                </div>
                
                <div class="status-options-modal" id="statusOptionsModal">
                    <div class="status-option-modal" data-status="未处理" onclick="selectStatusOption('未处理')">
                        未处理
                    </div>
                    <div class="status-option-modal" data-status="处理中" onclick="selectStatusOption('处理中')">
                        处理中
                    </div>
                    <div class="status-option-modal" data-status="已处理" onclick="selectStatusOption('已处理')">
                        已处理
                    </div>
                </div>
                
                <div class="modal-footer" style="border-top: none; padding: 0; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelEditStatusBtn">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmEditStatusBtn" disabled>确认修改</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 大事数据存储
        let events = [];
        let eventId = 1;
        
        // 自定义类型存储
        let customTypes = ['安全检查', '财务审计', '营销活动'];
        
        // 默认类型配置
        const defaultTypes = {
            personnel: { 
                name: '人员', 
                tagClass: 'tag-type-personnel',
                color: '#fa541c'
            },
            certification: { 
                name: '资质', 
                tagClass: 'tag-type-certification',
                color: '#52c41a'
            },
            equipment: { 
                name: '设备', 
                tagClass: 'tag-type-equipment',
                color: '#fa8c16'
            }
        };
        
        // DOM元素
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const manageTypesOverlay = document.getElementById('manageTypesOverlay');
        const editStatusModal = document.getElementById('editStatusModal');
        const eventForm = document.getElementById('eventForm');
        const activeEvents = document.getElementById('activeEvents');
        const completedTableBody = document.getElementById('completedTableBody');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const eventTypeSelect = document.getElementById('eventType');
        const customTypeContainer = document.getElementById('customTypeContainer');
        const customTypeInput = document.getElementById('customTypeInput');
        const addCustomTypeBtn = document.getElementById('addCustomTypeBtn');
        const customTagsContainer = document.getElementById('customTags');
        const manageTypesBtn = document.getElementById('manageTypesBtn');
        const closeManageTypesBtn = document.getElementById('closeManageTypesBtn');
        const closeManageModalBtn = document.getElementById('closeManageModalBtn');
        const newCustomTypeInput = document.getElementById('newCustomType');
        const addNewCustomTypeBtn = document.getElementById('addNewCustomTypeBtn');
        const manageCustomTags = document.getElementById('manageCustomTags');
        const closeEditStatusBtn = document.getElementById('closeEditStatusBtn');
        const cancelEditStatusBtn = document.getElementById('cancelEditStatusBtn');
        const confirmEditStatusBtn = document.getElementById('confirmEditStatusBtn');
        const currentStatusText = document.getElementById('currentStatusText');
        const statusOptionsModal = document.getElementById('statusOptionsModal');
        
        // 编辑状态相关变量
        let currentEditingEventId = null;
        let selectedNewStatus = null;
        
        // 状态选项
        const statusOptions = ['未处理', '处理中', '已处理'];
        
        // 状态颜色映射
        const statusColors = {
            '未处理': '#ff4d4f',
            '处理中': '#fa8c16',
            '已处理': '#52c41a'
        };
        
        // 自定义类型颜色池
        const customTypeColors = [
            { background: '#f9f0ff', color: '#722ed1' },
            { background: '#e6fffb', color: '#13c2c2' },
            { background: '#f0f5ff', color: '#2f54eb' },
            { background: '#fff2e8', color: '#fa541c' },
            { background: '#f6ffed', color: '#52c41a' },
            { background: '#fff7e6', color: '#fa8c16' },
            { background: '#fff1f0', color: '#cf1322' },
            { background: '#fafafa', color: '#595959' }
        ];
        
        // 弹窗控制
        openModalBtn.addEventListener('click', () => {
            modalOverlay.classList.add('active');
            // 设置默认日期为明天
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dueDate').valueAsDate = tomorrow;
            renderCustomTags();
        });
        
        closeModalBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });
        
        cancelBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });
        
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });
        
        // 管理自定义类型弹窗控制
        manageTypesBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
            manageTypesOverlay.classList.add('active');
            renderManageCustomTags();
        });
        
        closeManageTypesBtn.addEventListener('click', () => {
            manageTypesOverlay.classList.remove('active');
        });
        
        closeManageModalBtn.addEventListener('click', () => {
            manageTypesOverlay.classList.remove('active');
        });
        
        manageTypesOverlay.addEventListener('click', (e) => {
            if (e.target === manageTypesOverlay) {
                manageTypesOverlay.classList.remove('active');
            }
        });
        
        // 编辑状态弹窗控制
        closeEditStatusBtn.addEventListener('click', () => {
            editStatusModal.classList.remove('active');
            resetEditStatusModal();
        });
        
        cancelEditStatusBtn.addEventListener('click', () => {
            editStatusModal.classList.remove('active');
            resetEditStatusModal();
        });
        
        editStatusModal.addEventListener('click', (e) => {
            if (e.target === editStatusModal) {
                editStatusModal.classList.remove('active');
                resetEditStatusModal();
            }
        });
        
        // 大事类型选择变化
        eventTypeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customTypeContainer.classList.remove('hidden');
                customTypeInput.focus();
            } else {
                customTypeContainer.classList.add('hidden');
            }
        });
        
        // 添加自定义类型（在弹窗中）
        addCustomTypeBtn.addEventListener('click', function() {
            const typeName = customTypeInput.value.trim();
            if (typeName) {
                if (!customTypes.includes(typeName)) {
                    customTypes.push(typeName);
                    // 添加到下拉选项
                    const option = document.createElement('option');
                    option.value = typeName;
                    option.textContent = typeName;
                    eventTypeSelect.insertBefore(option, eventTypeSelect.lastElementChild);
                    
                    // 选中新添加的类型
                    eventTypeSelect.value = typeName;
                    customTypeContainer.classList.add('hidden');
                    customTypeInput.value = '';
                    
                    renderCustomTags();
                    showMessage(`自定义类型"${typeName}"已添加`, '#722ed1');
                } else {
                    alert('该类型已存在');
                }
            } else {
                alert('请输入类型名称');
            }
        });
        
        // 添加自定义类型（在管理页面）
        addNewCustomTypeBtn.addEventListener('click', function() {
            const typeName = newCustomTypeInput.value.trim();
            if (typeName) {
                if (!customTypes.includes(typeName)) {
                    customTypes.push(typeName);
                    // 添加到下拉选项（如果还没有）
                    const optionExists = Array.from(eventTypeSelect.options).some(opt => opt.value === typeName);
                    if (!optionExists) {
                        const option = document.createElement('option');
                        option.value = typeName;
                        option.textContent = typeName;
                        eventTypeSelect.insertBefore(option, eventTypeSelect.lastElementChild);
                    }
                    
                    newCustomTypeInput.value = '';
                    renderCustomTags();
                    renderManageCustomTags();
                    showMessage(`自定义类型"${typeName}"已添加`, '#722ed1');
                } else {
                    alert('该类型已存在');
                }
            } else {
                alert('请输入类型名称');
            }
        });
        
        // 删除自定义类型
        function deleteCustomType(typeName) {
            const index = customTypes.indexOf(typeName);
            if (index !== -1) {
                customTypes.splice(index, 1);
                
                // 从下拉选项中移除
                const option = eventTypeSelect.querySelector(`option[value="${typeName}"]`);
                if (option) {
                    option.remove();
                }
                
                renderCustomTags();
                renderManageCustomTags();
                showMessage(`自定义类型"${typeName}"已删除`, '#ff4d4f');
            }
        }
        
        // 渲染自定义类型标签（在弹窗中）
        function renderCustomTags() {
            customTagsContainer.innerHTML = '';
            customTypes.forEach(type => {
                const tag = document.createElement('div');
                tag.className = 'custom-tag';
                tag.innerHTML = `
                    ${type}
                    <button type="button" onclick="deleteCustomType('${type}')">×</button>
                `;
                customTagsContainer.appendChild(tag);
            });
        }
        
        // 渲染管理页面的自定义类型标签
        function renderManageCustomTags() {
            manageCustomTags.innerHTML = '';
            customTypes.forEach(type => {
                const tag = document.createElement('div');
                tag.className = 'custom-tag';
                tag.style.marginBottom = '8px';
                tag.innerHTML = `
                    ${type}
                    <button type="button" onclick="deleteCustomType('${type}')">×</button>
                `;
                manageCustomTags.appendChild(tag);
            });
            
            if (customTypes.length === 0) {
                manageCustomTags.innerHTML = '<div style="color: #999; text-align: center; padding: 40px;">暂无自定义类型</div>';
            }
        }
        
        // 打开编辑状态弹窗
        function openEditStatusModal(eventId, currentStatus) {
            currentEditingEventId = eventId;
            selectedNewStatus = null;
            
            // 获取大事信息
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            // 更新弹窗内容
            currentStatusText.textContent = event.status;
            currentStatusText.style.color = statusColors[event.status] || '#333';
            
            // 重置选项状态
            document.querySelectorAll('.status-option-modal').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-status') === event.status) {
                    option.classList.add('active');
                }
            });
            
            // 禁用确认按钮
            confirmEditStatusBtn.disabled = true;
            confirmEditStatusBtn.textContent = '确认修改';
            
            // 显示弹窗
            editStatusModal.classList.add('active');
        }
        
        // 选择状态选项（在编辑弹窗中）
        function selectStatusOption(status) {
            selectedNewStatus = status;
            
            // 更新选项样式
            document.querySelectorAll('.status-option-modal').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-status') === status) {
                    option.classList.add('active');
                }
            });
            
            // 启用确认按钮
            confirmEditStatusBtn.disabled = false;
        }
        
        // 确认编辑状态
        confirmEditStatusBtn.addEventListener('click', function() {
            if (!currentEditingEventId || !selectedNewStatus) return;
            
            const event = events.find(e => e.id === currentEditingEventId);
            if (!event) return;
            
            // 如果状态没有变化，直接关闭弹窗
            if (event.status === selectedNewStatus) {
                editStatusModal.classList.remove('active');
                resetEditStatusModal();
                return;
            }
            
            // 更新状态
            const oldStatus = event.status;
            event.status = selectedNewStatus;
            
            // 如果状态改为"已处理"，记录完成时间
            if (selectedNewStatus === '已处理' && oldStatus !== '已处理') {
                event.completedAt = new Date().toISOString();
            }
            
            // 如果从"已处理"改为其他状态，清除完成时间
            if (oldStatus === '已处理' && selectedNewStatus !== '已处理') {
                event.completedAt = null;
            }
            
            // 重新渲染
            renderEvents();
            
            // 关闭弹窗
            editStatusModal.classList.remove('active');
            resetEditStatusModal();
            
            // 显示提示
            showMessage(`状态已从"${oldStatus}"修改为"${selectedNewStatus}"`, statusColors[selectedNewStatus]);
        });
        
        // 重置编辑状态弹窗
        function resetEditStatusModal() {
            currentEditingEventId = null;
            selectedNewStatus = null;
            confirmEditStatusBtn.disabled = true;
        }
        
        // 获取类型配置
        function getTypeConfig(type) {
            // 如果是默认类型
            if (defaultTypes[type]) {
                return defaultTypes[type];
            }
            
            // 如果是自定义类型
            const colorIndex = Math.abs(type.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % customTypeColors.length;
            return {
                name: type,
                tagClass: 'tag-type-custom',
                color: customTypeColors[colorIndex].color,
                background: customTypeColors[colorIndex].background
            };
        }
        
        // 格式化日期
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}/${month}/${day}`;
        }
        
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            return `${year}/${month}/${day} ${hour}:${minute}`;
        }
        
        // 计算剩余天数
        function getDaysLeft(dueDate) {
            const due = new Date(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            due.setHours(0, 0, 0, 0);
            
            const diff = due.getTime() - today.getTime();
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        // 获取紧急程度
        function getUrgency(daysLeft) {
            if (daysLeft < 0) return {text: '已超期', isUrgent: true};
            if (daysLeft === 0) return {text: '今天截止', isUrgent: true};
            if (daysLeft <= 3) return {text: '紧急', isUrgent: true};
            if (daysLeft <= 7) return {text: '较急', isUrgent: false};
            return {text: '正常', isUrgent: false};
        }
        
        // 添加大事
        eventForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value.trim();
            const store = document.getElementById('storeName').value;
            const type = document.getElementById('eventType').value;
            const assignee = document.getElementById('assignee').value.trim();
            const dueDate = document.getElementById('dueDate').value;
            const description = document.getElementById('description').value.trim();
            
            if (!title || !store || !assignee || !dueDate) {
                alert('请填写所有必填项');
                return;
            }
            
            const newEvent = {
                id: eventId++,
                title,
                store,
                type,
                assignee,
                dueDate,
                description,
                status: '未处理',
                createdAt: new Date().toISOString(),
                completedAt: null,
                daysLeft: getDaysLeft(dueDate)
            };
            
            events.push(newEvent);
            renderEvents();
            modalOverlay.classList.remove('active');
            eventForm.reset();
            // 重置类型选择为默认
            eventTypeSelect.value = 'personnel';
            customTypeContainer.classList.add('hidden');
            
            showMessage('大事添加成功！', '#52c41a');
        });
        
        // 更新大事状态（从卡片中）
        function updateStatus(id, status) {
            const event = events.find(e => e.id === id);
            if (event) {
                const oldStatus = event.status;
                event.status = status;
                
                // 如果状态改为"已处理"，记录完成时间
                if (status === '已处理' && oldStatus !== '已处理') {
                    event.completedAt = new Date().toISOString();
                }
                
                // 如果从"已处理"改为其他状态，清除完成时间
                if (oldStatus === '已处理' && status !== '已处理') {
                    event.completedAt = null;
                }
                
                renderEvents();
                
                showMessage(`状态已更新为：${status}`, statusColors[status]);
            }
        }
        
        // 显示消息提示
        function showMessage(text, color) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                font-size: 14px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => message.remove(), 300);
            }, 2000);
        }
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // 渲染大事列表
        function renderEvents() {
            const typeFilter = document.querySelector('.filter-btn.active')?.getAttribute('data-filter') || 'all';
            
            // 分离进行中的大事和已处理的大事
            const activeEventsList = events.filter(event => event.status !== '已处理');
            const completedEventsList = events.filter(event => event.status === '已处理');
            
            // 过滤进行中的大事
            let filteredActiveEvents = activeEventsList.filter(event => {
                // 按类型过滤
                if (typeFilter !== 'all' && typeFilter !== 'urgent') {
                    if (typeFilter === 'custom') {
                        // 自定义类型过滤：不是默认类型的就是自定义类型
                        if (defaultTypes[event.type]) return false;
                    } else if (event.type !== typeFilter) {
                        return false;
                    }
                }
                
                // 按紧急程度过滤
                if (typeFilter === 'urgent') {
                    const urgency = getUrgency(event.daysLeft);
                    if (!urgency.isUrgent) return false;
                }
                
                return true;
            });
            
            // 排序：未处理优先，然后按紧急程度排序
            filteredActiveEvents.sort((a, b) => {
                // 按状态排序：未处理 > 处理中 > 已处理
                const statusOrder = { '未处理': 0, '处理中': 1, '已处理': 2 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                
                // 按剩余天数排序
                return a.daysLeft - b.daysLeft;
            });
            
            // 已处理大事按完成时间倒序排序
            completedEventsList.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            
            // 清空容器
            activeEvents.innerHTML = '';
            completedTableBody.innerHTML = '';
            
            // 显示进行中的大事
            if (filteredActiveEvents.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-icon">📋</div>
                    <p>暂无进行中的大事</p>
                    <p style="font-size: 13px; margin-top: 8px;">点击"添加大事"按钮创建新的大事</p>
                `;
                activeEvents.appendChild(emptyState);
            } else {
                // 创建进行中的大事卡片
                filteredActiveEvents.forEach(event => {
                    const daysLeft = getDaysLeft(event.dueDate);
                    const urgency = getUrgency(daysLeft);
                    const typeInfo = getTypeConfig(event.type);
                    
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    eventCard.innerHTML = `
                        <div class="card-header">
                            <div>
                                <div class="event-title">${event.title}</div>
                                <div class="event-tags">
                                    <span class="tag tag-store">${event.store}</span>
                                    <span class="tag ${typeInfo.tagClass}" style="${typeInfo.background ? `background: ${typeInfo.background}; color: ${typeInfo.color}` : ''}">
                                        ${typeInfo.name}
                                    </span>
                                    ${urgency.isUrgent ? 
                                        `<span class="tag tag-urgent">${urgency.text}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="event-meta">
                            <div class="event-meta-item">
                                <i>👤</i>
                                <span>负责人：${event.assignee}</span>
                            </div>
                            <div class="event-meta-item">
                                <i>📅</i>
                                <span>截止：${formatDate(event.dueDate)}</span>
                                <span style="margin-left: 5px; color: ${daysLeft < 0 ? '#cf1322' : daysLeft <= 3 ? '#fa541c' : '#389e0d'}">
                                    ${daysLeft < 0 ? `已超期${Math.abs(daysLeft)}天` : 
                                     daysLeft === 0 ? '今天截止' : 
                                     `剩余${daysLeft}天`}
                                </span>
                            </div>
                        </div>
                        
                        ${event.description ? `
                            <div style="font-size: 14px; color: #666; margin: 10px 0; padding: 10px; background: #fafafa; border-radius: 4px;">
                                ${event.description}
                            </div>
                        ` : ''}
                        
                        <div class="status-options">
                            ${statusOptions.map(status => `
                                <div class="status-option ${event.status === status ? 'active' : ''}" 
                                     data-status="${status}"
                                     onclick="updateStatus(${event.id}, '${status}')">
                                    ${status}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    activeEvents.appendChild(eventCard);
                });
            }
            
            // 显示已处理大事表格
            if (completedEventsList.length === 0) {
                completedTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                            暂无已处理完成的大事
                        </td>
                    </tr>
                `;
            } else {
                // 创建已处理大事表格行
                completedEventsList.forEach(event => {
                    const typeInfo = getTypeConfig(event.type);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${event.title}</div>
                            ${event.description ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${event.description}</div>` : ''}
                        </td>
                        <td>
                            <span class="table-tag tag-store">${event.store}</span>
                            <span class="table-tag ${typeInfo.tagClass}" style="${typeInfo.background ? `background: ${typeInfo.background}; color: ${typeInfo.color}` : ''}; margin-left: 5px;">
                                ${typeInfo.name}
                            </span>
                        </td>
                        <td>${event.assignee}</td>
                        <td>${formatDateTime(event.completedAt)}</td>
                        <td>
                            <button class="btn-edit-status" onclick="openEditStatusModal(${event.id}, '${event.status}')">
                                <i class="fas fa-edit"></i> 编辑状态
                            </button>
                        </td>
                    `;
                    completedTableBody.appendChild(row);
                });
            }
        }
        
        // 过滤事件
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                renderEvents();
            });
        });
        
        // 添加示例数据
        function addSampleEvents() {
            const samples = [
                {
                    id: eventId++,
                    title: '现烤师傅招聘',
                    store: '朝阳门店',
                    type: 'personnel',
                    assignee: '张经理',
                    dueDate: '2023-12-15',
                    description: '需要招聘有经验的现烤师傅2名，要求有3年以上经验',
                    status: '处理中',
                    createdAt: '2023-11-20T10:30:00',
                    daysLeft: getDaysLeft('2023-12-15')
                },
                {
                    id: eventId++,
                    title: '食品经营许可证年审',
                    store: '公司总部',
                    type: 'certification',
                    assignee: '李总监',
                    dueDate: '2024-01-20',
                    description: '准备年审材料，确保通过市场监督管理局检查',
                    status: '未处理',
                    createdAt: '2023-11-18T14:20:00',
                    daysLeft: getDaysLeft('2024-01-20')
                },
                {
                    id: eventId++,
                    title: '烤箱设备维护保养',
                    store: '海淀门店',
                    type: 'equipment',
                    assignee: '王主管',
                    dueDate: '2023-12-05',
                    description: '定期维护保养生产设备，更换磨损部件',
                    status: '已处理',
                    createdAt: '2023-11-15T09:10:00',
                    completedAt: '2023-11-25T16:30:00',
                    daysLeft: getDaysLeft('2023-12-05')
                },
                {
                    id: eventId++,
                    title: '季度安全检查',
                    store: '东城门店',
                    type: '安全检查',
                    assignee: '刘主任',
                    dueDate: '2023-12-10',
                    description: '进行季度安全大检查，重点检查消防设施和用电安全',
                    status: '处理中',
                    createdAt: '2023-11-22T11:45:00',
                    daysLeft: getDaysLeft('2023-12-10')
                },
                {
                    id: eventId++,
                    title: '年度财务审计',
                    store: '公司总部',
                    type: '财务审计',
                    assignee: '赵总监',
                    dueDate: '2024-01-15',
                    description: '准备年度财务审计材料，配合审计机构工作',
                    status: '未处理',
                    createdAt: '2023-11-24T16:20:00',
                    daysLeft: getDaysLeft('2024-01-15')
                }
            ];
            
            // 确保自定义类型存在于类型列表中
            samples.forEach(sample => {
                if (!defaultTypes[sample.type] && !customTypes.includes(sample.type)) {
                    customTypes.push(sample.type);
                    // 添加到下拉选项
                    const option = document.createElement('option');
                    option.value = sample.type;
                    option.textContent = sample.type;
                    eventTypeSelect.insertBefore(option, eventTypeSelect.lastElementChild);
                }
            });
            
            events.push(...samples);
        }
        
        // 初始化
        function init() {
            // 添加示例数据
            addSampleEvents();
            renderEvents();
            renderCustomTags();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
